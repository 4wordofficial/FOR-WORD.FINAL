<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원가입 - FOR:WORD</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --background: 48 24% 96%;
      --foreground: 221 39% 11%;
      --muted: 220 9% 46%;
      --muted-foreground: 220 9% 46%;
      --card: 0 0% 100%;
      --primary: 211 39% 23%;
      --primary-foreground: 0 0% 100%;
      --secondary: 152 56% 38%;
      --secondary-foreground: 0 0% 100%;
      --destructive: 0 72% 51%;
      --border: 220 13% 91%;
    }
    .dark {
      --background: 222 49% 8%;
      --foreground: 220 48% 94%;
      --muted: 222 17% 70%;
      --muted-foreground: 222 17% 70%;
      --card: 221 51% 12%;
      --primary: 220 100% 74%;
      --primary-foreground: 222 49% 8%;
      --secondary: 160 64% 58%;
      --secondary-foreground: 222 49% 8%;
      --border: 218 34% 22%;
    }
    html { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
    body { background: hsl(var(--background)); color: hsl(var(--foreground)); min-height: 100vh; -webkit-font-smoothing: antialiased; }

    .container { min-height: 100vh; display: flex; }

    /* Left Panel - Secondary color */
    .left-panel {
      display: none; flex: 1;
      background: hsl(var(--secondary));
      padding: 3rem;
      flex-direction: column; justify-content: space-between;
    }
    @media (min-width: 1024px) { .left-panel { display: flex; } }

    .logo-row { display: flex; align-items: center; gap: 0.75rem; }
    .logo-box {
      width: 3rem; height: 3rem; border-radius: 0.75rem;
      background: hsl(var(--secondary-foreground) / 0.2);
      display: flex; align-items: center; justify-content: center;
    }
    .logo-box svg { width: 1.5rem; height: 1.5rem; color: hsl(var(--secondary-foreground)); }
    .logo-text { font-size: 1.5rem; font-weight: 700; color: hsl(var(--secondary-foreground)); }

    .hero-content { max-width: 28rem; }
    .hero-title { font-size: 2.25rem; font-weight: 700; color: hsl(var(--secondary-foreground)); margin-bottom: 1.5rem; line-height: 1.3; }
    .hero-desc { font-size: 1.125rem; color: hsl(var(--secondary-foreground) / 0.8); line-height: 1.7; }

    .steps-list { display: flex; flex-direction: column; gap: 1rem; }
    .step-item { display: flex; align-items: center; gap: 1rem; }
    .step-number {
      width: 2.5rem; height: 2.5rem; border-radius: 0.5rem;
      background: hsl(var(--secondary-foreground) / 0.1);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: hsl(var(--secondary-foreground));
    }
    .step-text { color: hsl(var(--secondary-foreground)); }

    /* Right Panel */
    .right-panel { flex: 1; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
    @media (min-width: 1024px) { .right-panel { padding: 3rem; } }

    .form-container { width: 100%; max-width: 28rem; }

    .mobile-logo { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 3rem; }
    @media (min-width: 1024px) { .mobile-logo { display: none; } }
    .mobile-logo .logo-box { background: hsl(var(--secondary)); }
    .mobile-logo .logo-box svg { color: hsl(var(--secondary-foreground)); }
    .mobile-logo .logo-text { color: hsl(var(--foreground)); }

    .form-header { margin-bottom: 2rem; }
    .form-title { font-size: 1.5rem; font-weight: 700; color: hsl(var(--foreground)); margin-bottom: 0.5rem; }
    .form-subtitle { color: hsl(var(--muted-foreground)); }

    .form-group { margin-bottom: 1.25rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: hsl(var(--foreground)); margin-bottom: 0.5rem; }

    .input-wrapper { position: relative; }
    .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: 1.25rem; height: 1.25rem; color: hsl(var(--muted)); }

    .input-action {
      position: absolute; right: 0.75rem; top: 50%;
      transform: translateY(-50%);
      width: 2.25rem; height: 2.25rem;
      border: none; background: transparent;
      display: inline-flex; align-items: center; justify-content: center;
      color: hsl(var(--muted));
      cursor: pointer;
      border-radius: 0.5rem;
      transition: background 0.2s, color 0.2s;
    }
    .input-action:hover { background: hsl(var(--border) / 0.6); color: hsl(var(--foreground)); }
    .input-action:focus { outline: none; box-shadow: 0 0 0 3px hsl(var(--secondary) / 0.2); }
    .input-action svg { width: 1.25rem; height: 1.25rem; }

    .paper-input {
      width: 100%; padding: 0.75rem 1rem 0.75rem 3rem;
      border-radius: 0.75rem; border: 1px solid hsl(var(--border));
      background: hsl(var(--card)); color: hsl(var(--foreground));
      font-size: 1rem; font-family: inherit; transition: all 0.2s;
    }
    .paper-input.has-action { padding-right: 3.25rem; }
    .paper-input::placeholder { color: hsl(var(--muted) / 0.6); }
    .paper-input:focus { outline: none; border-color: hsl(var(--secondary)); box-shadow: 0 0 0 3px hsl(var(--secondary) / 0.2); }

    .error-text { font-size: 0.875rem; color: hsl(var(--destructive)); margin-top: 0.5rem; }

    .ink-button-secondary {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      width: 100%; padding: 0.75rem 1.25rem; border-radius: 0.75rem;
      font-weight: 500; font-size: 1rem; font-family: inherit;
      background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground));
      border: none; cursor: pointer; transition: all 0.2s;
    }
    .ink-button-secondary:hover { opacity: 0.9; box-shadow: 0 4px 12px hsl(var(--secondary) / 0.3); }
    .ink-button-secondary:active { transform: scale(0.98); }
    .ink-button-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
    .ink-button-secondary svg { width: 1.25rem; height: 1.25rem; }

    .login-link { margin-top: 2rem; text-align: center; color: hsl(var(--muted-foreground)); }
    .login-link a { color: hsl(var(--secondary)); font-weight: 500; text-decoration: none; }
    .login-link a:hover { text-decoration: underline; }

    .spinner { width: 1.25rem; height: 1.25rem; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Divider + OAuth button */
    .divider {
      display: flex; align-items: center;
      gap: 1rem;
      margin: 1.25rem 0;
      color: hsl(var(--muted-foreground));
      font-size: 0.875rem;
    }
    .divider::before, .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: hsl(var(--border));
    }
    .outline-button {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.65rem;
      width: 100%; padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 500; font-size: 1rem; font-family: inherit;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      border: 1px solid hsl(var(--border));
      cursor: pointer;
      transition: all 0.2s;
    }
    .outline-button:hover { box-shadow: 0 6px 14px hsl(var(--foreground) / 0.08); }
    .outline-button:active { transform: scale(0.99); }
    .outline-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .outline-button svg { width: 1.25rem; height: 1.25rem; }
  
    /* Left Panel CTA accent color reference */
    .left-panel { --cta-fg: var(--secondary-foreground); }
    @media (prefers-reduced-motion: no-preference) {
      .left-panel .steps-list .step-item {
        animation: ctaFadeUp 980ms cubic-bezier(.2,.9,.2,1) both;
        will-change: transform, opacity, filter;
      }
      .left-panel .steps-list .step-item:nth-child(1) { animation-delay: 600ms; }
      .left-panel .steps-list .step-item:nth-child(2) { animation-delay: 760ms; }
      .left-panel .steps-list .step-item:nth-child(3) { animation-delay: 920ms; }

      .left-panel .steps-list .step-item:nth-child(1) .step-number { animation: ctaPop 800ms cubic-bezier(.2,.9,.2,1) both; animation-delay: 640ms; }
      .left-panel .steps-list .step-item:nth-child(2) .step-number { animation: ctaPop 800ms cubic-bezier(.2,.9,.2,1) both; animation-delay: 800ms; }
      .left-panel .steps-list .step-item:nth-child(3) .step-number { animation: ctaPop 800ms cubic-bezier(.2,.9,.2,1) both; animation-delay: 960ms; }
    }

    /* =========================
       Left CTA Motion (FOR:WORD)
       ========================= */
    .left-panel { position: relative; overflow: hidden; }
    .left-panel > * { position: relative; z-index: 1; }

    .hero-title .cta-highlight { position: relative; display: inline-block; z-index: 0; }
    .hero-title .cta-highlight::after {
      content: "";
      position: absolute;
      left: -0.18em; right: -0.18em;
      bottom: 0.12em;
      height: 0.58em;
      background: hsl(var(--cta-fg) / 0.18);
      border-radius: 0.55em;
      transform: scaleX(0);
      transform-origin: left;
      z-index: -1;
    }

    @keyframes ctaFadeUp {
      0%   { opacity: 0; transform: translateY(14px); filter: blur(10px); }
      60%  { opacity: 1; transform: translateY(0);    filter: blur(0); }
      100% { opacity: 1; transform: translateY(0);    filter: blur(0); }
    }
    @keyframes ctaReveal {
      0%   { opacity: 0; transform: translateY(16px); clip-path: inset(0 100% 0 0); filter: blur(10px); }
      60%  { opacity: 1; transform: translateY(0);    clip-path: inset(0 0 0 0);   filter: blur(0); }
      100% { opacity: 1; transform: translateY(0);    clip-path: inset(0 0 0 0);   filter: blur(0); }
    }
    @keyframes highlightSweep {
      0%   { transform: scaleX(0); opacity: 0.0; }
      35%  { opacity: 1.0; }
      100% { transform: scaleX(1); opacity: 1.0; }
    }
    @keyframes ctaAmbientIn {
      0%   { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes ctaPop {
      0%   { opacity: 0; transform: scale(0.92); }
      60%  { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    @media (prefers-reduced-motion: no-preference) {
      .left-panel::before {
        content: "";
        position: absolute;
        inset: -40%;
        background:
          radial-gradient(circle at 18% 20%, hsl(var(--cta-fg) / 0.10), transparent 55%),
          radial-gradient(circle at 82% 30%, hsl(var(--cta-fg) / 0.08), transparent 55%),
          radial-gradient(circle at 50% 80%, hsl(var(--cta-fg) / 0.06), transparent 55%);
        filter: blur(14px);
        opacity: 0;
        animation: ctaAmbientIn 1700ms ease-out both;
        pointer-events: none;
      }

      .left-panel .logo-row {
        animation: ctaFadeUp 860ms cubic-bezier(.2,.9,.2,1) both;
        animation-delay: 60ms;
        will-change: transform, opacity, filter;
      }
      .left-panel .hero-title {
        animation: ctaReveal 1180ms cubic-bezier(.2,.9,.2,1) both;
        animation-delay: 170ms;
        will-change: transform, opacity, clip-path, filter;
      }
      .left-panel .hero-desc {
        animation: ctaFadeUp 1080ms cubic-bezier(.2,.9,.2,1) both;
        animation-delay: 380ms;
        will-change: transform, opacity, filter;
      }
      .left-panel .hero-title .cta-highlight::after {
        animation: highlightSweep 1080ms cubic-bezier(.2,.9,.2,1) both;
        animation-delay: 820ms;
        will-change: transform, opacity;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .left-panel::before, .left-panel * { animation: none !important; transition: none !important; }
      .hero-title .cta-highlight::after { transform: none; }
    }

</style>
</head>
<body>
  <div class="container">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="logo-row">
        <div class="logo-box">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/>
          </svg>
        </div>
        <span class="logo-text">FOR:WORD</span>
      </div>
      <div class="hero-content">
        <h1 class="hero-title">잊히기 전에 <span class="cta-highlight">문장</span>이 됩니다.</h1>
        <p class="hero-desc">흩어진 메모를 한곳에 모으고, 다시 꺼내 글로 잇습니다.</p>
      </div>
      <div class="steps-list">
        <div class="step-item"><div class="step-number">1</div><span class="step-text">메모를 자유롭게 기록</span></div>
        <div class="step-item"><div class="step-number">2</div><span class="step-text">주제에 맞게 다시 돌아오기</span></div>
        <div class="step-item"><div class="step-number">3</div><span class="step-text">초안으로 이어 쓰기</span></div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <div class="form-container">
        <div class="mobile-logo">
          <div class="logo-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/>
            </svg>
          </div>
          <span class="logo-text">FOR:WORD</span>
        </div>

        <div class="form-header">
          <h2 class="form-title">시작하기</h2>
          <p class="form-subtitle">계정을 만들고 글쓰기를 시작하세요</p>
        </div>

        <form id="signupForm">
          <div class="form-group">
            <label class="form-label" for="name">이름</label>
            <div class="input-wrapper">
              <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/>
              </svg>
              <input type="text" id="name" class="paper-input" placeholder="홍길동" autocomplete="name" autofocus>
            </div>
            <p id="nameError" class="error-text hidden"></p>
          </div>

          <div class="form-group">
            <label class="form-label" for="email">이메일</label>
            <div class="input-wrapper">
              <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
              </svg>
              <input type="email" id="email" class="paper-input" placeholder="example@email.com" autocomplete="email">
            </div>
            <p id="emailError" class="error-text hidden"></p>
          </div>

          <div class="form-group">
            <label class="form-label" for="password">비밀번호</label>
            <div class="input-wrapper">
              <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="11" x="3" y="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <input type="password" id="password" class="paper-input has-action" placeholder="8자 이상, 영어/숫자/특수문자 조합" autocomplete="new-password">
              <button type="button" class="input-action" id="togglePassword" aria-label="비밀번호 보기" aria-pressed="false">
                <svg id="pwEye" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
                </svg>
                <svg id="pwEyeOff" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><line x1="3" y1="3" x2="21" y2="21"/>
                </svg>
              </button>
            </div>
            <p id="passwordError" class="error-text hidden"></p>
          </div>

          <div class="form-group">
            <label class="form-label" for="passwordConfirm">비밀번호 확인</label>
            <div class="input-wrapper">
              <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="11" x="3" y="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <input type="password" id="passwordConfirm" class="paper-input has-action" placeholder="비밀번호를 다시 입력" autocomplete="new-password">
              <button type="button" class="input-action" id="togglePasswordConfirm" aria-label="비밀번호 확인 보기" aria-pressed="false">
                <svg id="pw2Eye" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
                </svg>
                <svg id="pw2EyeOff" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><line x1="3" y1="3" x2="21" y2="21"/>
                </svg>
              </button>
            </div>
            <p id="passwordConfirmError" class="error-text hidden"></p>
          </div>

          <button type="submit" id="submitBtn" class="ink-button-secondary">
            <span id="btnText">회원가입</span>
            <svg id="btnArrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
            </svg>
            <div id="btnSpinner" class="spinner hidden"></div>
          </button>
        </form>

        <div class="divider">또는</div>

        <button type="button" id="googleBtn" class="outline-button" aria-label="Google로 계속">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 533.5 544.3" aria-hidden="true">
            <path fill="currentColor" d="M533.5 278.4c0-17.4-1.6-34.1-4.6-50.4H272v95.3h146.9c-6.3 34.1-25.2 63-53.8 82.3v68h87c50.9-46.9 81.4-116 81.4-195.2z"/>
            <path fill="currentColor" d="M272 544.3c73.7 0 135.5-24.5 180.7-66.6l-87-68c-24.1 16.2-55 25.8-93.7 25.8-71.9 0-132.8-48.5-154.6-113.6H27.5v71.5C72.4 475.2 165.3 544.3 272 544.3z"/>
            <path fill="currentColor" d="M117.4 321.9c-10.4-30.9-10.4-64.3 0-95.2V155.2H27.5c-38.8 77.6-38.8 169.6 0 247.2l89.9-80.5z"/>
            <path fill="currentColor" d="M272 107.7c40.1-.6 78.7 14.1 108.3 41.6l81.1-81.1C411.8 24.5 350 0 272 0 165.3 0 72.4 69.1 27.5 155.2l89.9 71.5C139.2 156.2 200.1 107.7 272 107.7z"/>
          </svg>
          <span>Google로 계속</span>
          <div id="googleSpinner" class="spinner hidden"></div>
        </button>

        <div class="login-link">이미 계정이 있으신가요? <a href="login.html">로그인</a></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    const AUTH_KEY = 'forword.auth.v1';
    const THEME_KEY = 'forword.theme';

    function normalizeProviderId(pid) {
      if (!pid) return 'firebase';
      if (pid === 'google.com') return 'google';
      if (pid === 'password') return 'password';
      return pid;
    }

    // Apply theme
    if (localStorage.getItem(THEME_KEY) === 'dark') {
      document.documentElement.classList.add('dark');
    }

    // Firebase config (same as login.html)
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyC4Xz5BQEt4SYaKqP8qU9ocac__VQbVgD0",
      authDomain: "forword-7af6f.firebaseapp.com",
      projectId: "forword-7af6f",
      storageBucket: "forword-7af6f.firebasestorage.app",
      messagingSenderId: "828952645956",
      appId: "1:828952645956:web:8c25750ea52be169650711",
      measurementId: "G-7VPEYGEZL3"
    };

    function firebaseConfigured() {
      if (!window.firebase || !firebase.initializeApp) return false;
      const s = JSON.stringify(FIREBASE_CONFIG || {});
      return !s.includes('YOUR_API_KEY') && !s.includes('YOUR_PROJECT_ID') && !s.includes('YOUR_APP_ID');
    }

    // Elements
    const form = document.getElementById('signupForm');
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const passwordConfirmInput = document.getElementById('passwordConfirm');

    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const passwordConfirmError = document.getElementById('passwordConfirmError');

    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnArrow = document.getElementById('btnArrow');
    const btnSpinner = document.getElementById('btnSpinner');

    const googleBtn = document.getElementById('googleBtn');
    const googleSpinner = document.getElementById('googleSpinner');

    function clearErrors() {
      [nameError, emailError, passwordError, passwordConfirmError].forEach(el => {
        if (!el) return;
        el.textContent = '';
        el.classList.add('hidden');
      });
    }

    function setFieldError(el, message) {
      if (!el) return;
      if (!message) {
        el.textContent = '';
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function setLoading(target, isLoading) {
      if (target === 'email') {
        submitBtn.disabled = !!isLoading;
        btnText.classList.toggle('hidden', !!isLoading);
        btnArrow.classList.toggle('hidden', !!isLoading);
        btnSpinner.classList.toggle('hidden', !isLoading);
      }
      if (target === 'google') {
        googleBtn.disabled = !!isLoading;
        googleSpinner.classList.toggle('hidden', !isLoading);
      }
    }


    async function ensureLocalPersistence() {
      if (!auth || !auth.setPersistence) return;
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      } catch (e) {
        // ignore; Auth will fall back to default persistence
      }
    }

    function mapAuthError(err) {
      const code = (err && err.code) ? String(err.code) : '';
      switch (code) {
        case 'auth/invalid-email': return '올바른 이메일 형식이 아닙니다.';
        case 'auth/email-already-in-use': return '이미 가입된 이메일입니다. 로그인해주세요.';
        case 'auth/weak-password': return '비밀번호가 너무 약합니다. 더 강한 비밀번호를 사용해주세요.';
        case 'auth/operation-not-allowed': return '이 로그인 방식이 비활성화되어 있습니다. 관리자에게 문의해주세요.';
        case 'auth/too-many-requests': return '시도 횟수가 많습니다. 잠시 후 다시 시도해주세요.';
        case 'auth/network-request-failed': return '네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
        case 'auth/popup-closed-by-user': return '로그인 팝업이 닫혔습니다.';
        case 'auth/account-exists-with-different-credential': return '같은 이메일로 다른 로그인 방식이 이미 연결되어 있습니다. 해당 방식으로 로그인해주세요.';
        case 'auth/credential-already-in-use': return '해당 계정은 이미 다른 사용자에 연결되어 있습니다.';
        default: return (err && err.message) ? err.message : '처리에 실패했습니다. 다시 시도해주세요.';
      }
    }

    // Firebase init
    let auth = null;
    let db = null;
    let redirectInProgress = false;

    if (firebaseConfigured()) {
      try {
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        auth = firebase.auth();
        try { db = firebase.firestore(); } catch (e) { db = null; }

        // 로그인 상태 유지
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});

        // (auth routing removed) 로그인 상태 자동 라우팅은 home.html에서만 처리합니다.

      } catch (e) {
        console.warn('Firebase init failed:', e);
      }
    }

    async function ensureUserDoc(user) {
      if (!db || !user || !user.uid) return { onboardingComplete: false };
      const ref = db.collection('users').doc(user.uid);
      const now = firebase.firestore.FieldValue.serverTimestamp();
      const providerIds = Array.from(new Set((user.providerData || []).map(p => p && p.providerId).filter(Boolean)));

      const base = {
        uid: user.uid,
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        providerIds,
        lastLoginAt: now
      };

      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({ ...base, createdAt: now, onboardingComplete: false }, { merge: true });
        return { onboardingComplete: false };
      }
      await ref.set(base, { merge: true });
      return snap.data() || { onboardingComplete: false };
    }

    async function persistAndRedirect(user, provider) {
      if (!user) return;

      const profile = await ensureUserDoc(user);
      const onboardingComplete = !!profile.onboardingComplete;

      localStorage.setItem(AUTH_KEY, JSON.stringify({
        uid: user.uid || null,
        email: user.email || null,
        displayName: user.displayName || null,
        provider: normalizeProviderId(provider || null),
        onboardingComplete
      }));

      window.location.replace(onboardingComplete ? 'home.html' : 'onboarding.html');
    }

    // Password preview toggles
    function attachPasswordToggle(inputId, btnId, eyeId, eyeOffId) {
      const input = document.getElementById(inputId);
      const btn = document.getElementById(btnId);
      const eye = document.getElementById(eyeId);
      const eyeOff = document.getElementById(eyeOffId);
      if (!input || !btn || !eye || !eyeOff) return;

      btn.addEventListener('click', () => {
        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        btn.setAttribute('aria-pressed', String(isHidden));
        eye.classList.toggle('hidden', isHidden);
        eyeOff.classList.toggle('hidden', !isHidden);
      });
    }
    attachPasswordToggle('password', 'togglePassword', 'pwEye', 'pwEyeOff');
    attachPasswordToggle('passwordConfirm', 'togglePasswordConfirm', 'pw2Eye', 'pw2EyeOff');

    function validatePassword(pw) {
      const hasLetter = /[A-Za-z]/.test(pw);
      const hasNumber = /[0-9]/.test(pw);
      const hasSpecial = /[^A-Za-z0-9]/.test(pw);
      const longEnough = pw.length >= 8;
      return longEnough && hasLetter && hasNumber && hasSpecial;
    }

    // Email/password sign up
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();

      const name = (nameInput.value || '').trim();
      const email = (emailInput.value || '').trim();
      const password = passwordInput.value || '';
      const passwordConfirm = passwordConfirmInput.value || '';

      let hasError = false;

      if (!name) { setFieldError(nameError, '이름을 입력해주세요.'); hasError = true; }
      else if (name.length < 2) { setFieldError(nameError, '이름은 2글자 이상이어야 합니다.'); hasError = true; }

      if (!email) { setFieldError(emailError, '이메일을 입력해주세요.'); hasError = true; }
      else if (!email.includes('@')) { setFieldError(emailError, '올바른 이메일 형식이 아닙니다.'); hasError = true; }

      if (!password) { setFieldError(passwordError, '비밀번호를 입력해주세요.'); hasError = true; }
      else if (!validatePassword(password)) { setFieldError(passwordError, '비밀번호는 8자 이상이며, 영어/숫자/특수문자를 모두 포함해야 합니다.'); hasError = true; }

      if (!passwordConfirm) { setFieldError(passwordConfirmError, '비밀번호 확인을 입력해주세요.'); hasError = true; }
      else if (password !== passwordConfirm) { setFieldError(passwordConfirmError, '비밀번호가 일치하지 않습니다.'); hasError = true; }

      if (hasError) return;

      setLoading('email', true);
      try {
        if (!auth) {
          setFieldError(emailError, 'Firebase 설정이 필요합니다. (Firebase 초기화 실패)');
          return;
        }

        await ensureLocalPersistence();
        const cred = await auth.createUserWithEmailAndPassword(email, password);

        if (cred && cred.user) {
          if (name) await cred.user.updateProfile({ displayName: name });
          redirectInProgress = true;
          await persistAndRedirect(cred.user, 'password');
        }
      } catch (err) {
        const msg = mapAuthError(err);
        const code = (err && err.code) ? String(err.code) : '';
        if (code.includes('email')) setFieldError(emailError, msg);
        else if (code.includes('password')) setFieldError(passwordError, msg);
        else setFieldError(emailError, msg);
      } finally {
        setLoading('email', false);
      }
    });

    // Google sign in (same behavior as login.html)
    googleBtn.addEventListener('click', async () => {
      clearErrors();
      setLoading('google', true);

      try {
        if (!auth) {
          setFieldError(emailError, 'Google 로그인을 사용하려면 Firebase 설정이 필요합니다.');
          return;
        }

        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        await ensureLocalPersistence();
        const result = await auth.signInWithPopup(provider);
        redirectInProgress = true;
        await persistAndRedirect(result.user, 'google');
      } catch (err) {
        const code = (err && err.code) ? String(err.code) : '';
        if (code === 'auth/popup-closed-by-user') return;
        setFieldError(emailError, mapAuthError(err));
      } finally {
        setLoading('google', false);
      }
    });
  </script>
</body>
</html>
