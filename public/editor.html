<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Editor | FOR:WORD Standalone</title>
    <meta
      name="description"
      content="ë¬¸ì„œÂ·ë…¸íŠ¸Â·ì‚°ì¶œë¬¼ì„ A4 ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” FOR:WORD Editor í˜ì´ì§€"
    />

    <!-- Inter í°íŠ¸ -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --background: 220 40% 98%;
        --foreground: 220 30% 20%;

        --card: 0 0% 100%;
        --card-foreground: 220 30% 20%;

        --popover: 0 0% 100%;
        --popover-foreground: 220 30% 20%;

        --primary: 90 60% 70%;
        --primary-foreground: 90 40% 20%;

        --secondary: 320 70% 88%;
        --secondary-foreground: 320 40% 25%;

        --muted: 220 25% 96%;
        --muted-foreground: 220 15% 50%;

        --accent: 200 75% 80%;
        --accent-foreground: 200 40% 25%;

        --destructive: 350 70% 65%;
        --destructive-foreground: 0 0% 100%;

        --border: 220 20% 90%;
        --input: 220 20% 90%;
        --ring: 90 60% 70%;

        --radius: 1rem;
      }

      *,
      ::before,
      ::after {
        border-color: hsl(var(--border));
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: hsl(var(--foreground));
        background-color: hsl(var(--background));
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¤‘ì•™ A4 ì—ë””í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .a4-wrapper {
        padding: 12px 0 24px;
        display: flex;
        justify-content: center;
      }

      .a4-page {
        position: relative;
        width: 100%;
        max-width: 1020px;
        aspect-ratio: 210 / 297; /* A4 ì„¸ë¡œ ë¹„ìœ¨ */
        background-color: #ffffff;
        border-radius: 0;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.1);
        border: 1px solid hsl(var(--border));
        padding: 32px 36px;
        display: flex;
        flex-direction: column;
      }

      /* ì¢Œì¸¡ íŒ¨ë„ì´ ì ‘í˜”ì„ ë•Œ A4 ê°€ë¡œ í­ í™•ì¥ */
      #editor-layout.left-collapsed .a4-page {
        max-width: 1180px;
      }

      .a4-page-header {
        position: absolute;
        top: 16px;
        right: 28px;
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        letter-spacing: 0.08em;
      }

      .page-body {
        outline: none;
        font-size: 0.95rem;
        line-height: 1.7;
        color: hsl(var(--foreground));
        flex: 1;
        overflow-y: auto;
        margin-top: 8px;
        white-space: pre-wrap;
      }

      .page-body:empty::before {
        content: "ì—¬ê¸°ì—ì„œ ë¬¸ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.";
        color: hsl(var(--muted-foreground));
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¢Œì¸¡ íŠ¸ë¦¬ ìŠ¤íƒ€ì¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .tree-scroll {
        scrollbar-width: thin;
        scrollbar-color: hsl(var(--muted-foreground)) transparent;
      }

      .tree-scroll::-webkit-scrollbar {
        width: 6px;
      }

      .tree-scroll::-webkit-scrollbar-track {
        background: transparent;
      }

      .tree-scroll::-webkit-scrollbar-thumb {
        background: hsla(var(--muted-foreground), 0.3);
        border-radius: 9999px;
      }

      .tree-item-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        border-radius: 9999px;
        padding: 4px 8px;
        cursor: pointer;
        transition: background-color 0.12s ease, color 0.12s ease;
      }

      .tree-item-row:hover {
        background-color: hsl(var(--muted));
      }

      .tree-item-row.active {
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
      }

      .tree-item-title {
        flex: 1;
        min-width: 0;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tree-item-prefix {
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 0;
      }

      .tree-actions {
        display: flex;
        align-items: center;
        gap: 2px;
        opacity: 0;
        transition: opacity 0.12s ease;
      }

      .tree-item-row:hover .tree-actions {
        opacity: 1;
      }

      .tree-actions button {
        border-radius: 9999px;
        border: 1px solid transparent;
        background-color: transparent;
        padding: 2px;
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .tree-actions button:hover {
        background-color: hsla(var(--muted-foreground), 0.08);
      }

      .tree-actions button[data-action="delete"]:hover {
        background-color: hsla(var(--destructive), 0.12);
      }

      .tree-drop-target {
        outline: 1px dashed hsla(var(--primary), 0.8);
        outline-offset: 1px;
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì—ë””í„° íˆ´ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .editor-toolbar button {
        border-radius: 9999px;
        border-width: 1px;
        border-style: solid;
        border-color: transparent;
        background-color: hsl(var(--card));
        padding: 4px 8px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .editor-toolbar button:hover {
        background-color: hsl(var(--muted));
      }

      .editor-toolbar button[data-active="true"] {
        border-color: hsl(var(--primary));
        background-color: hsla(var(--primary), 0.18);
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¹ˆ ìƒíƒœ ì˜¤ë²„ë ˆì´ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .editor-empty {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-align: center;
        padding: 0 32px;
        background: radial-gradient(
            circle at top left,
            rgba(255, 255, 255, 0.9),
            transparent 60%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(255, 255, 255, 0.9),
            transparent 60%
          );
      }

      .editor-empty-icon {
        display: flex;
        height: 48px;
        width: 48px;
        border-radius: 9999px;
        align-items: center;
        justify-content: center;
        border: 1px dashed hsl(var(--border));
        background-color: hsla(var(--card), 0.9);
      }

      .editor-empty p {
        margin: 0;
      }

      .editor-empty-primary {
        font-size: 12px;
        color: #9aaad5;
      }

      .editor-empty-secondary {
        font-size: 12px;
        color: hsl(var(--muted-foreground));
      }

      /* ì¸ë°•ìŠ¤ ë©”ëª¨ ì¸ìš© ìŠ¤íƒ€ì¼ */
      .memo-citation {
        font-size: 0.8rem;
        color: hsl(var(--muted-foreground));
        margin-top: 0.25rem;
        font-style: normal;
      }

      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* ìš°ì¸¡ íƒ­ ì»¨í…ì¸  ê¸°ë³¸ ìˆ¨ê¹€ */
      .tab-content {
        display: none;
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3ë¶„í•  ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #editor-layout {
        display: grid;
        gap: 1.5rem;
      }

      @media (min-width: 1024px) {
        #editor-layout {
          grid-template-columns: 280px minmax(0, 2.2fr) minmax(0, 1fr);
        }
        #editor-layout.left-collapsed {
          grid-template-columns: 56px minmax(0, 2.6fr) minmax(0, 1.1fr);
        }
      }

      #left-panel {
        transition: width 0.18s ease, padding 0.18s ease;
        overflow: hidden; /* ëª¨ì„œë¦¬ í´ë¦¬í•‘, ìŠ¤í¬ë¡¤ì€ floating-panelì—ì„œ */
      }

      #left-panel.left-collapsed .left-panel-header-text,
      #left-panel.left-collapsed .left-panel-add-buttons,
      #left-panel.left-collapsed #left-panel-main {
        display: none;
      }

      #left-panel.left-collapsed .left-panel-header {
        justify-content: center;
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í”Œë¡œíŒ…(ìŠ¤í‹°í‚¤) íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .floating-panel {
        position: sticky;
        top: 96px; /* ë„¤ë¹„+ìƒë‹¨ ì—¬ë°± í”¼í•´ì„œ ê³ ì • */
        align-self: flex-start;
        max-height: calc(100vh - 120px);
        overflow-y: auto;   /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ */
        overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ìˆ¨ê¹€ */
      }
    

      /* Toast (Graphì™€ ë™ì¼í•œ ë°©ì‹) */
      .toast-container {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 60;
      }
      .toast {
        padding: 12px 14px;
        border-radius: 12px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        border: 1px solid hsl(var(--border));
        background-color: hsl(var(--card));
        font-weight: 600;
        color: hsl(var(--foreground));
      }
</style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              popover: {
                DEFAULT: "hsl(var(--popover))",
                foreground: "hsl(var(--popover-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
          },
        },
      };
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-functions-compat.js"></script>
  </head>
  <body
    class="min-h-screen bg-background text-foreground"
    style="font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"
  >
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="border-b border-border bg-card/50 backdrop-blur-sm sticky top-0 z-50">
      <div class="max-w-[1600px] mx-auto px-6 sm:px-8 lg:px-12">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-8">
            <a
              href="home.html"
              class="text-xl font-bold bg-gradient-to-r from-primary via-accent to-secondary bg-clip-text text-transparent"
            >
              FOR:WORD
            </a>
            <div class="hidden md:flex gap-1" id="nav-links"></div>
          </div>

          <!-- ğŸ”¹ ìš°ì¸¡ ìƒë‹¨ ë¡œê·¸ì•„ì›ƒ (Homeê³¼ ë™ì¼ ìŠ¤íƒ€ì¼) -->
          <div class="flex items-center gap-3">
            <button
              id="logout-btn"
              class="inline-flex items-center gap-2 rounded-full border border-border px-3 py-1.5 text-xs font-medium text-muted-foreground hover:bg-muted hover:text-foreground transition"
            >
              <i data-lucide="log-out" class="w-3 h-3"></i>
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- ë©”ì¸ -->
    <main class="max-w-[2000px] mx-auto px-6 sm:px-8 lg:px-12 py-8">
      <div class="space-y-6">
        <!-- 3ë¶„í•  ë ˆì´ì•„ì›ƒ -->
        <div id="editor-layout" class="grid gap-6">
          <!-- ì¢Œì¸¡: ë¬¸ì„œ íŠ¸ë¦¬ -->
          <aside
            id="left-panel"
            class="floating-panel rounded-xl border bg-card/80 backdrop-blur-sm shadow-sm flex flex-col min-h-[420px]"
          >
            <div
              class="left-panel-header flex items-center justify-between px-3 py-3 border-b border-border/70"
            >
              <div class="left-panel-header-text">
                <p
                  class="text-xs font-semibold tracking-[0.16em] text-muted-foreground uppercase"
                >
                  STRUCTURE
                </p>
              </div>
              <div class="flex items-center gap-1">
                <div class="left-panel-add-buttons flex items-center gap-2">
                  <div class="flex flex-col items-center gap-0.5">
                    <button
                      id="add-root-folder"
                      class="inline-flex items-center justify-center h-7 w-7 rounded-full border border-input bg-background hover:bg-muted/70 text-muted-foreground"
                      title="ë£¨íŠ¸ì— í´ë” ì¶”ê°€"
                    >
                      <i data-lucide="folder-plus" class="w-3.5 h-3.5"></i>
                    </button>
                  </div>
                  <div class="flex flex-col items-center gap-0.5">
                    <button
                      id="add-root-file"
                      class="inline-flex items-center justify-center h-7 w-7 rounded-full border border-input bg-background hover:bg-muted/70 text-muted-foreground"
                      title="ë£¨íŠ¸ì— ë¬¸ì„œ ì¶”ê°€"
                    >
                      <i data-lucide="file-plus-2" class="w-3.5 h-3.5"></i>
                    </button>
                  </div>
                </div>
                <button
                  id="toggle-left-panel"
                  class="left-panel-toggle-btn inline-flex items-center justify-center h-7 w-7 rounded-full border border-input bg-background hover:bg-muted/70 text-muted-foreground"
                  title="íŒ¨ë„ ì ‘ê¸°"
                >
                  <i
                    id="left-toggle-icon"
                    data-lucide="chevron-left"
                    class="w-3.5 h-3.5"
                  ></i>
                </button>
              </div>
            </div>

            <!-- ì¢Œì¸¡ íŒ¨ë„ ë©”ì¸ -->
            <div id="left-panel-main" class="flex-1 flex flex-col">
              <!-- í´ë”/ë¬¸ì„œ ì´ë¦„ ì…ë ¥ ë°” -->
              <div
                id="project-input-bar"
                class="px-3 pt-2 pb-3 border-b border-border bg-muted/40 hidden"
              >
                <form id="project-input-form" class="flex items-center gap-2">
                  <input
                    id="project-input"
                    type="text"
                    class="flex-1 rounded-full border border-input bg-background px-3 py-1.5 text-xs outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary/40"
                    placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    autocomplete="off"
                  />
                  <div class="flex items-center gap-1">
                    <button
                      type="submit"
                      class="inline-flex items-center justify-center h-7 w-7 rounded-full border border-input bg-primary text-primary-foreground hover:brightness-105"
                      title="ì¶”ê°€"
                    >
                      <i data-lucide="check" class="w-3.5 h-3.5"></i>
                    </button>
                    <button
                      type="button"
                      id="project-input-cancel"
                      class="inline-flex items-center justify-center h-7 w-7 rounded-full border border-input bg-background hover:bg-muted/70 text-muted-foreground"
                      title="ì·¨ì†Œ"
                    >
                      <i data-lucide="x" class="w-3.5 h-3.5"></i>
                    </button>
                  </div>
                </form>
              </div>

              <div class="flex-1 overflow-y-auto tree-scroll px-2 py-3">
                <ul id="project-tree" class="space-y-1 text-xs"></ul>

                <!-- ë¬¸ì„œê°€ í•˜ë‚˜ë„ ì—†ì„ ë•Œ ì¢Œì¸¡ íŒíŠ¸ -->
                <div
                  id="tree-empty-hint"
                  class="mt-10 text-[11px] text-muted-foreground text-center px-4 hidden"
                >
                  ì•„ì§ ìƒì„±ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.<br />
                  ìœ„ì˜ <span class="font-semibold">íŒŒì¼ ì•„ì´ì½˜</span>ì„ ëˆŒëŸ¬ ì²« ë¬¸ì„œë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.
                </div>
              </div>
            </div>
          </aside>

          <!-- ì¤‘ì•™: A4 ì—ë””í„° -->
          <section
            class="flex flex-col rounded-xl border bg-muted/60 backdrop-blur-sm shadow-sm min-h-[520px]"
          >
            <div class="flex items-center justify-between px-4 py-3 border-b border-border/70">
              <div class="flex items-center gap-2">
                <span
                  class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-card border border-border text-xs text-muted-foreground"
                >
                  <i data-lucide="file-pen" class="w-3.5 h-3.5"></i>
                </span>
                <div>
                  <p
                    id="editor-current-title"
                    class="text-sm font-semibold text-foreground truncate max-w-[220px]"
                  >
                    ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”
                  </p>
                </div>
              </div>

              <div class="flex items-center gap-2 editor-toolbar">
                <button id="btn-bold" type="button" title="êµµê²Œ (Ctrl/Cmd + B)">
                  <i data-lucide="bold" class="w-3.5 h-3.5"></i>
                </button>
                <button id="btn-italic" type="button" title="ê¸°ìš¸ì„ (Ctrl/Cmd + I)">
                  <i data-lucide="italic" class="w-3.5 h-3.5"></i>
                </button>
                <button id="btn-h2" type="button" title="ì†Œì œëª©">
                  <span class="text-[11px] font-semibold">H2</span>
                </button>
                <button id="btn-bullet" type="button" title="ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸">
                  <i data-lucide="list" class="w-3.5 h-3.5"></i>
                </button>
                <button id="btn-save-now" type="button" title="ì§€ê¸ˆ ë°”ë¡œ ì €ì¥">
                  <i data-lucide="save" class="w-3.5 h-3.5"></i>
                </button>
              </div>
            </div>

            <div class="flex-1 overflow-hidden relative">
              <!-- ë¬¸ì„œ ì—†ì„ ë•Œ ë¹ˆ ìƒíƒœ -->
              <div id="editor-empty" class="editor-empty">
                <div class="editor-empty-icon">
                  <i data-lucide="file-text" class="w-6 h-6 text-[#9AAAD5]"></i>
                </div>
                <div class="space-y-1">
                  <p class="editor-empty-primary">ì•„ì§ ìƒì„±ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                  <p class="editor-empty-secondary">
                    ì¢Œì¸¡ì—ì„œ ìƒˆ ë¬¸ì„œë¥¼ ë§Œë“¤ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬<br />ì²« ë¬¸ì„œë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.
                  </p>
                </div>
                <button
                  id="create-first-doc"
                  class="mt-2 inline-flex items-center gap-2 rounded-full bg-[#8FD4B9] px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-[#7AC6A8] active:scale-[0.99] transition"
                >
                  <i data-lucide="file-plus-2" class="w-3.5 h-3.5"></i>
                  ì²« ë¬¸ì„œ ë§Œë“¤ê¸°
                </button>
              </div>

              <!-- ì‹¤ì œ A4 í˜ì´ì§€ ì˜ì—­ -->
              <div
                id="pages-container"
                class="h-full overflow-y-auto py-2 px-2 hidden"
              ></div>
            </div>

            <div
              class="flex items-center justify-between px-4 py-2 border-t border-border/70 text-[11px] text-muted-foreground"
            >
              <span id="save-status">ì €ì¥ ëŒ€ê¸° ì¤‘</span>
              <span id="meta-pages" class="opacity-80">í˜ì´ì§€ 0</span>
            </div>
          </section>

          <!-- ìš°ì¸¡: AI / ë©”ëª¨ / ì—°ê²° íƒ­ -->
          <aside
            class="floating-panel rounded-xl border bg-card text-card-foreground shadow-sm flex flex-col min-h-[420px]"
          >
            <div class="flex flex-col h-full">
              <div
                class="grid w-full grid-cols-3 m-2 rounded-lg bg-muted/60 p-1 gap-1"
                id="tab-triggers"
              >
                <button
                  data-tab="ai"
                  class="tab-trigger text-xs inline-flex items-center justify-center gap-1 px-2 py-2 rounded-md text-muted-foreground hover:text-foreground"
                >
                  <i data-lucide="bot" class="h-4 w-4"></i>
                  AI
                </button>
                <button
                  data-tab="memo"
                  class="tab-trigger text-xs inline-flex items-center justify-center gap-1 px-2 py-2 rounded-md text-muted-foreground hover:text-foreground"
                >
                  <i data-lucide="sticky-note" class="h-4 w-4"></i>
                  ë©”ëª¨
                </button>
                <button
                  data-tab="link"
                  class="tab-trigger text-xs inline-flex items-center justify-center gap-1 px-2 py-2 rounded-md text-muted-foreground hover:text-foreground"
                >
                  <i data-lucide="link" class="h-4 w-4"></i>
                  ì—°ê²°
                </button>
              </div>
              <div class="border-t border-border"></div>
              <div class="flex-1 overflow-y-auto">
                <section
                  data-content="ai"
                  class="tab-content h-full p-4 space-y-3"
                  id="ai-tab"
                ></section>
                <section
                  data-content="memo"
                  class="tab-content h-full"
                  id="memo-tab"
                ></section>
                <section
                  data-content="link"
                  class="tab-content h-full p-4 space-y-3"
                  id="link-tab"
                ></section>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>

    <div id="toast-root" class="toast-container"></div>

    <script>
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 0) Theme + Firebase init (Homeê³¼ ë™ì¼í•œ ë™ì‘)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const AUTH_KEY = 'forword.auth.v1';
      const THEME_KEY = 'forword.theme';

      const __fw_isLocalFile = window.location.protocol === 'file:' || window.location.origin === 'null';

      if (localStorage.getItem(THEME_KEY) === 'dark') {
        document.documentElement.classList.add('dark');
      }

      const firebaseConfig = {
        apiKey: "AIzaSyC4Xz5BQEt4SYaKqP8qU9ocac__VQbVgD0",
        authDomain: "forword-7af6f.firebaseapp.com",
        projectId: "forword-7af6f",
        storageBucket: "forword-7af6f.firebasestorage.app",
        messagingSenderId: "828952645956",
        appId: "1:828952645956:web:8c25750ea52be169650711",
        measurementId: "G-7VPEYGEZL3",
      };

      // ğŸ”¹ Canonical host ê°•ì œ: web.app / firebaseapp.com í˜¼ìš©ìœ¼ë¡œ ì¸í•œ ì„¸ì…˜ ë¶„ë¦¬(=ë¡œê·¸ì•„ì›ƒì²˜ëŸ¼ ë³´ì„) ë°©ì§€
      (function enforceCanonicalHost() {
        const canonical = "forword-7af6f.web.app";
        const alt = "forword-7af6f.firebaseapp.com";
        if (location.hostname === alt) {
          const next = location.href.replace(alt, canonical);
          location.replace(next);
        }
      })();


      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const auth = firebase.auth();
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((e) => {
        console.warn("[Auth] setPersistence(LOCAL) failed; falling back to SESSION:", e);
        return auth.setPersistence(firebase.auth.Auth.Persistence.SESSION).catch((e2) => {
          console.warn("[Auth] setPersistence(SESSION) also failed:", e2);
        });
      });
const db = firebase.firestore();
      const functions = firebase.app().functions('asia-northeast3');
      let currentUser = null;
      let memosCache = []; // Firestore memos

      function safeJsonParse(raw, fallback = null) {
        try { return JSON.parse(raw); } catch { return fallback; }
      }
      function readAuthCache() {
        const cached = safeJsonParse(localStorage.getItem(AUTH_KEY) || "null", null);
        return cached && typeof cached === "object" ? cached : null;
      }
      function writeAuthCache(user, onboardingComplete) {
        if (!user) return;
        const providerId =
          (user.providerData && user.providerData[0] && user.providerData[0].providerId) ||
          (user.isAnonymous ? "anonymous" : "firebase");
        const provider =
          providerId === "google.com" ? "google" : providerId === "password" ? "password" : providerId;

        localStorage.setItem(
          AUTH_KEY,
          JSON.stringify({
            uid: user.uid || null,
            email: user.email || null,
            displayName: user.displayName || null,
            provider,
            onboardingComplete: !!onboardingComplete,
          })
        );
      }

      async function ensureUserProfile(user) {
        if (!db || !user || !user.uid) return { onboardingComplete: false };
        const ref = db.collection("users").doc(user.uid);

        const now = firebase.firestore.FieldValue.serverTimestamp();
        const providerIds = Array.from(
          new Set((user.providerData || []).map((p) => p && p.providerId).filter(Boolean))
        );

        const base = {
          uid: user.uid,
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          providerIds,
          lastSeenAt: now,
        };

        const snap = await ref.get();
        if (!snap.exists) {
          await ref.set({ ...base, createdAt: now, onboardingComplete: false }, { merge: true });
          return { onboardingComplete: false };
        }

        await ref.set(base, { merge: true });
        return snap.data() || { onboardingComplete: false };
      }


      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µí†µ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const navigation = [
        { name: 'Dashboard', href: 'index.html', icon: 'layout-dashboard' },
        { name: 'Graph', href: 'graph.html', icon: 'network' },
        { name: 'Projects', href: 'projects.html', icon: 'folder-kanban' },
        { name: 'Editor', href: 'editor.html', icon: 'file-pen' },
        { name: 'Outputs', href: 'outputs.html', icon: 'file-output' },
      ];



      const navLinks = document.getElementById("nav-links");
      function renderNavigation(activeName) {
        navLinks.innerHTML = navigation
          .map(
            (item) => `
          <a
            href="${item.href}"
            class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
              item.name === activeName
                ? "bg-primary text-primary-foreground"
                : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
            }"
          >
            <i data-lucide="${item.icon}" class="w-4 h-4"></i>
            ${item.name}
          </a>
        `
          )
          .join("");
        if (window.lucide) window.lucide.createIcons();
      }
      renderNavigation("Editor");
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Toast (Graphì™€ ë™ì¼í•œ ë°©ì‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const toastRoot = document.getElementById("toast-root");
      const showToast = (message) => {
        if (!toastRoot) {
          console.warn("[Toast]", message);
          return;
        }
        const el = document.createElement("div");
        el.className = "toast";
        el.textContent = message;
        toastRoot.appendChild(el);
        setTimeout(() => el.remove(), 2200);
      };


      // ğŸ”¹ ë¡œê·¸ì•„ì›ƒ (Homeê³¼ ë™ì¼ ë¡œì§)
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await auth.signOut();
          } catch (e) {
            console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", e);
          } finally {
            localStorage.removeItem(AUTH_KEY);
            window.location.href = "login.html";
          }
        });
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // íŠ¸ë¦¬ & ì—ë””í„° ê´€ë ¨ DOM
      const treeEl = document.getElementById("project-tree");
      const treeEmptyHint = document.getElementById("tree-empty-hint");
      const pagesContainer = document.getElementById("pages-container");
      const editorEmptyEl = document.getElementById("editor-empty");
      const createFirstDocBtn = document.getElementById("create-first-doc");

      const projectInputBar = document.getElementById("project-input-bar");
      const projectInputForm = document.getElementById("project-input-form");
      const projectInput = document.getElementById("project-input");
      const projectInputCancel = document.getElementById(
        "project-input-cancel"
      );
      const btnAddRootFolder = document.getElementById("add-root-folder");
      const btnAddRootFile = document.getElementById("add-root-file");

      const editorTitleLabel = document.getElementById("editor-current-title");
      const saveStatusEl = document.getElementById("save-status");
      const pagesMetaEl = document.getElementById("meta-pages");

      // (ìš°ì¸¡ META íŒ¨ë„ì€ ì œê±°ë¨ â†’ optional)
      const docTitleInput = document.getElementById("doc-title-input");
      const docTagsInput = document.getElementById("doc-tags-input");
      const docMetaCreated = document.getElementById("doc-meta-created");
      const docMetaUpdated = document.getElementById("doc-meta-updated");

      const btnBold = document.getElementById("btn-bold");
      const btnItalic = document.getElementById("btn-italic");
      const btnH2 = document.getElementById("btn-h2");
      const btnBullet = document.getElementById("btn-bullet");
      const btnSaveNow = document.getElementById("btn-save-now");

      // ì¢Œì¸¡ íŒ¨ë„ ì ‘ê¸° ê´€ë ¨
      const editorLayout = document.getElementById("editor-layout");
      const leftPanel = document.getElementById("left-panel");
      const toggleLeftBtn = document.getElementById("toggle-left-panel");
      const leftToggleIcon = document.getElementById("left-toggle-icon");
      let isLeftCollapsed = false;

      if (toggleLeftBtn && editorLayout && leftPanel) {
        toggleLeftBtn.addEventListener("click", () => {
          isLeftCollapsed = !isLeftCollapsed;
          editorLayout.classList.toggle("left-collapsed", isLeftCollapsed);
          leftPanel.classList.toggle("left-collapsed", isLeftCollapsed);

          if (leftToggleIcon) {
            leftToggleIcon.setAttribute(
              "data-lucide",
              isLeftCollapsed ? "chevron-right" : "chevron-left"
            );
            if (window.lucide) window.lucide.createIcons();
          }
          toggleLeftBtn.setAttribute(
            "title",
            isLeftCollapsed ? "íŒ¨ë„ í¼ì¹˜ê¸°" : "íŒ¨ë„ ì ‘ê¸°"
          );
        });
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŠ¸ë¦¬ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const projectState = {
        addType: null,
        addParentId: null,
        selectedId: null,
      };

      const editorState = {
        currentDocId: null,
        saveTimer: null,
        isSaving: false,
        lastSaved: null,
        createdAt: null,
      };

      let projectTree = [];
      let dragNodeId = null;

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Handle opening a draft document passed via query parameters
      // When the editor is opened with ?doc=<docId>, this helper will ensure that the
      // document is added to the project tree (if it doesn't already exist) and opened.
      async function handleDraftDocFromQuery() {
        try {
          const params = new URLSearchParams(window.location.search);
          const docId = params.get('doc');
          if (!docId || !currentUser) return;
          // Check if the node already exists in the tree
          let node = findNode(docId);
          if (!node) {
            // create a root-level file node with a placeholder title
            const newNode = {
              id: docId,
              type: 'file',
              title: 'Draft Document',
            };
            projectTree.push(newNode);
            persistTree();
            node = newNode;
          }
          projectState.selectedId = docId;
          renderProjectTree();
          const targetNode = findNode(docId);
          if (targetNode) {
            await openDocForNode(targetNode);
          }
        } catch (e) {
          console.error('handleDraftDocFromQuery error:', e);
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function genId(prefix = "node") {
        return `${prefix}_${Date.now().toString(36)}_${Math.random()
          .toString(36)
          .slice(2, 7)}`;
      }

      function formatDateTime(ts) {
        if (!ts) return "-";
        const d =
          typeof ts === "number" ? new Date(ts) : ts.toDate ? ts.toDate() : new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}.${m}.${day} ${hh}:${mm}`;
      }

      function loadTreeFromStorage() {
        return [];
      }

      function saveTreeToStorage() {
        /* no-op: localStorage ì‚¬ìš© ì•ˆ í•¨ */
      }

      // íŠ¸ë¦¬ Firestore ì €ì¥/ë¡œë“œ
      async function loadTreeFromFirestore(user) {
        if (!user) return null;
        try {
          const docRef = db
            .collection("users")
            .doc(user.uid)
            .collection("settings")
            .doc("editorTree");
          const snap = await docRef.get();
          if (!snap.exists) return null;
          const data = snap.data() || {};
          if (Array.isArray(data.tree)) return data.tree;
          return null;
        } catch (e) {
          console.error("íŠ¸ë¦¬ Firestore ë¡œë“œ ì˜¤ë¥˜:", e);
          return null;
        }
      }

      function saveTreeToFirestore() {
        if (!currentUser) return;
        try {
          const docRef = db
            .collection("users")
            .doc(currentUser.uid)
            .collection("settings")
            .doc("editorTree");
          docRef
            .set(
              {
                tree: projectTree,
                updatedAt: Date.now(),
              },
              { merge: true }
            )
            .catch((e) =>
              console.error("íŠ¸ë¦¬ Firestore ì €ì¥ ì˜¤ë¥˜(set ë‚´ë¶€):", e)
            );
        } catch (e) {
          console.error("íŠ¸ë¦¬ Firestore ì €ì¥ ì˜¤ë¥˜:", e);
        }
      }

      function persistTree() {
        saveTreeToFirestore();
      }

      function findNode(id, nodes = projectTree) {
        for (const node of nodes) {
          if (node.id === id) return node;
          if (node.type === "folder" && Array.isArray(node.children)) {
            const found = findNode(id, node.children);
            if (found) return found;
          }
        }
        return null;
      }

      function findNodeAndParent(id, nodes = projectTree, parent = null) {
        for (let i = 0; i < nodes.length; i++) {
          const node = nodes[i];
          if (node.id === id) {
            return { node, parent, index: i };
          }
          if (node.type === "folder" && Array.isArray(node.children)) {
            const found = findNodeAndParent(id, node.children, node);
            if (found) return found;
          }
        }
        return null;
      }

      function detachNode(id) {
        const res = findNodeAndParent(id, projectTree, null);
        if (!res) return null;
        const { node, parent, index } = res;
        if (parent) {
          parent.children.splice(index, 1);
        } else {
          projectTree.splice(index, 1);
        }
        return node;
      }

      function insertNodeAsChild(parentNode, node) {
        if (parentNode.type !== "folder") return;
        if (!Array.isArray(parentNode.children)) parentNode.children = [];
        parentNode.children.push(node);
      }

      function insertNodeAfterSibling(targetId, node) {
        const res = findNodeAndParent(targetId, projectTree, null);
        if (!res) return;
        const { parent, index } = res;
        const list = parent ? parent.children : projectTree;
        list.splice(index + 1, 0, node);
      }

      function treeHasFile(nodes = projectTree) {
        for (const node of nodes) {
          if (node.type === "file") return true;
          if (node.children && treeHasFile(node.children)) return true;
        }
        return false;
      }

      function getFirstFileNode(nodes = projectTree) {
        for (const node of nodes) {
          if (node.type === "file") return node;
          if (node.children) {
            const found = getFirstFileNode(node.children);
            if (found) return found;
          }
        }
        return null;
      }

      function updateEditorEmptyState(hasFile) {
        if (!editorEmptyEl || !pagesContainer || !treeEmptyHint) return;
        if (hasFile) {
          editorEmptyEl.classList.add("hidden");
          pagesContainer.classList.remove("hidden");
          treeEmptyHint.classList.add("hidden");
        } else {
          editorEmptyEl.classList.remove("hidden");
          pagesContainer.classList.add("hidden");
          treeEmptyHint.classList.remove("hidden");
          if (editorTitleLabel) {
            editorTitleLabel.textContent = "ë¬¸ì„œë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”";
          }
          if (docTitleInput) docTitleInput.value = "";
          if (docTagsInput) docTagsInput.value = "";
          if (docMetaCreated) docMetaCreated.textContent = "-";
          if (docMetaUpdated) docMetaUpdated.textContent = "-";
          pagesMetaEl.textContent = "í˜ì´ì§€ 0";
          editorState.currentDocId = null;
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŠ¸ë¦¬ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderProjectTree() {
        treeEl.innerHTML = "";

        function createNodeElement(node, depth) {
          const li = document.createElement("li");
          li.dataset.id = node.id;

          const row = document.createElement("div");
          row.className = "tree-item-row";
          if (node.id === projectState.selectedId) {
            row.classList.add("active");
          }
          row.style.paddingLeft = `${4 + depth * 12}px`;

          const prefix = document.createElement("div");
          prefix.className = "tree-item-prefix";

          const iconSpan = document.createElement("span");
          iconSpan.className =
            "inline-flex items-center justify-center h-5 w-5 rounded-full border border-border/80 bg-background/70";
          const icon = document.createElement("i");
          icon.setAttribute(
            "data-lucide",
            node.type === "folder" ? "folder" : "file-text"
          );
          icon.className = "w-3 h-3 text-muted-foreground";
          iconSpan.appendChild(icon);

          const titleSpan = document.createElement("span");
          titleSpan.className = "tree-item-title";
          titleSpan.textContent = node.title || (node.type === "folder" ? "í´ë”" : "ë¬¸ì„œ");

          prefix.appendChild(iconSpan);
          prefix.appendChild(titleSpan);

          const actions = document.createElement("div");
          actions.className = "tree-actions";

          if (node.type === "folder") {
            const btnAddSubFile = document.createElement("button");
            btnAddSubFile.type = "button";
            btnAddSubFile.dataset.action = "add-file";
            btnAddSubFile.dataset.id = node.id;
            btnAddSubFile.title = "ì´ í´ë”ì— ë¬¸ì„œ ì¶”ê°€";
            btnAddSubFile.innerHTML =
              '<i data-lucide="file-plus-2" class="w-3 h-3"></i>';

            const btnAddSubFolder = document.createElement("button");
            btnAddSubFolder.type = "button";
            btnAddSubFolder.dataset.action = "add-folder";
            btnAddSubFolder.dataset.id = node.id;
            btnAddSubFolder.title = "í•˜ìœ„ í´ë” ì¶”ê°€";
            btnAddSubFolder.innerHTML =
              '<i data-lucide="folder-plus" class="w-3 h-3"></i>';

            actions.appendChild(btnAddSubFile);
            actions.appendChild(btnAddSubFolder);
          }

          const btnDelete = document.createElement("button");
          btnDelete.type = "button";
          btnDelete.dataset.action = "delete";
          btnDelete.dataset.id = node.id;
          btnDelete.title = node.type === "folder" ? "í´ë” ì‚­ì œ" : "ë¬¸ì„œ ì‚­ì œ";
          btnDelete.innerHTML = '<i data-lucide="trash-2" class="w-3 h-3"></i>';
          actions.appendChild(btnDelete);

          row.addEventListener("click", (e) => {
            if (e.target.closest("button[data-action]")) return;
            projectState.selectedId = node.id;
            renderProjectTree();
            if (node.type === "file") {
              openDocForNode(node);
            }
          });

          row.appendChild(prefix);
          row.appendChild(actions);

          li.appendChild(row);

          if (node.type === "folder" && Array.isArray(node.children) && node.children.length) {
            const ul = document.createElement("ul");
            ul.className = "mt-0.5 space-y-0.5";
            node.children.forEach((child) => {
              ul.appendChild(createNodeElement(child, depth + 1));
            });
            li.appendChild(ul);
          }

          li.draggable = true;
          return li;
        }

        projectTree.forEach((node) => {
          treeEl.appendChild(createNodeElement(node, 0));
        });

        updateEditorEmptyState(treeHasFile());

        if (window.lucide) window.lucide.createIcons();
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŠ¸ë¦¬ ì…ë ¥ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function openInputBar(kind, parentId) {
        projectState.addType = kind;
        projectState.addParentId = parentId || null;
        projectInputBar.classList.remove("hidden");
        projectInput.value = "";
        projectInput.placeholder =
          kind === "folder" ? "ìƒˆ í´ë” ì´ë¦„" : "ìƒˆ ë¬¸ì„œ ì œëª©";
        projectInput.focus();
      }

      projectInputForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!projectState.addType) {
          projectInputBar.classList.add("hidden");
          return;
        }
        let name = projectInput.value.trim();
        if (!name) name = projectState.addType === "folder" ? "ìƒˆ í´ë”" : "ìƒˆ ë¬¸ì„œ";

        const newId = genId("doc");
        const newNode =
          projectState.addType === "folder"
            ? { id: newId, type: "folder", title: name, children: [] }
            : { id: newId, type: "file", title: name };

        if (projectState.addParentId) {
          const parent = findNode(projectState.addParentId, projectTree);
          if (parent && parent.type === "folder") {
            if (!Array.isArray(parent.children)) parent.children = [];
            parent.children.push(newNode);
          } else {
            projectTree.push(newNode);
          }
        } else {
          projectTree.push(newNode);
        }

        projectState.selectedId = newNode.id;
        persistTree();
        renderProjectTree();

        if (newNode.type === "file") {
          updateEditorEmptyState(true);
          openDocForNode(newNode);
        }

        projectState.addType = null;
        projectState.addParentId = null;
        projectInputBar.classList.add("hidden");
      });

      projectInputCancel.addEventListener("click", () => {
        projectState.addType = null;
        projectState.addParentId = null;
        projectInputBar.classList.add("hidden");
      });

      btnAddRootFolder.addEventListener("click", () => openInputBar("folder", null));
      btnAddRootFile.addEventListener("click", () => openInputBar("file", null));
      if (createFirstDocBtn) {
        createFirstDocBtn.addEventListener("click", () => openInputBar("file", null));
      }

      // íŠ¸ë¦¬ ì•¡ì…˜ (add-file / add-folder / delete)
      treeEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (!id) return;

        if (action === "add-file") {
          openInputBar("file", id);
        } else if (action === "add-folder") {
          openInputBar("folder", id);
        } else if (action === "delete") {
          handleDeleteNode(id);
        }
      });

      function handleDeleteNode(id) {
        const res = findNodeAndParent(id, projectTree);
        if (!res) return;
        const { node } = res;
        if (
          node.type === "folder" &&
          node.children &&
          node.children.length &&
          !confirm("ì´ í´ë”ì™€ ì•ˆì˜ ëª¨ë“  ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”?")
        ) {
          return;
        }
        if (node.type === "file") {
          if (!confirm("ì´ ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”? (ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
        }
        detachNode(id);
        persistTree();

        if (node.type === "file" && currentUser) {
          db.collection("users")
            .doc(currentUser.uid)
            .collection("docs")
            .doc(node.id)
            .delete()
            .catch((e) => console.error("ë¬¸ì„œ ì‚­ì œ ì˜¤ë¥˜:", e));
        }

        const hasFile = treeHasFile();
        if (!hasFile) {
          projectState.selectedId = null;
          pagesContainer.innerHTML = "";
          updateEditorEmptyState(false);
        } else {
          const firstFile = getFirstFileNode();
          if (firstFile) {
            projectState.selectedId = firstFile.id;
            renderProjectTree();
            openDocForNode(firstFile);
          } else {
            renderProjectTree();
          }
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŠ¸ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      treeEl.addEventListener("dragstart", (e) => {
        const li = e.target.closest("li[data-id]");
        if (!li) return;
        dragNodeId = li.dataset.id;
        e.dataTransfer.effectAllowed = "move";
      });

      treeEl.addEventListener("dragover", (e) => {
        const li = e.target.closest("li[data-id]");
        if (!li) return;
        e.preventDefault();
        li.classList.add("tree-drop-target");
      });

      treeEl.addEventListener("dragleave", (e) => {
        const li = e.target.closest("li[data-id]");
        if (!li) return;
        li.classList.remove("tree-drop-target");
      });

      treeEl.addEventListener("drop", (e) => {
        const li = e.target.closest("li[data-id]");
        if (!li) return;
        e.preventDefault();
        li.classList.remove("tree-drop-target");
        const targetId = li.dataset.id;
        if (!dragNodeId || dragNodeId === targetId) {
          dragNodeId = null;
          return;
        }
        const moved = detachNode(dragNodeId);
        dragNodeId = null;
        if (!moved) return;

        const targetNode = findNode(targetId, projectTree);
        if (!targetNode) return;

        if (targetNode.type === "folder") {
          insertNodeAsChild(targetNode, moved);
        } else {
          insertNodeAfterSibling(targetNode.id, moved);
        }
        persistTree();
        renderProjectTree();
      });

      treeEl.addEventListener("dragend", () => {
        dragNodeId = null;
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì—ë””í„° ê´€ë ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function getActiveEditor() {
        return pagesContainer.querySelector(".page-body");
      }

      // ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬
      function handleEditorPaste(e) {
        const editor = e.currentTarget;
        if (!editor || !editor.classList.contains("page-body")) return;

        const clipboard = e.clipboardData || window.clipboardData;
        if (!clipboard) return;

        e.preventDefault();

        let html = clipboard.getData("text/html");
        const text = clipboard.getData("text/plain");

        if (html) {
          try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            if (doc && doc.body) {
              html = doc.body.innerHTML;
            }
          } catch (err) {
            console.warn("í´ë¦½ë³´ë“œ HTML íŒŒì‹± ì˜¤ë¥˜:", err);
          }

          try {
            document.execCommand("insertHTML", false, html);
          } catch (err) {
            console.warn("insertHTML ì‹¤í–‰ ì˜¤ë¥˜:", err);
            editor.innerHTML += html;
          }
        } else if (text) {
          const escaped = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
          const htmlFromText = escaped.replace(/\r?\n/g, "<br>");
          try {
            document.execCommand("insertHTML", false, htmlFromText);
          } catch (err) {
            console.warn("í…ìŠ¤íŠ¸ insertHTML ì‹¤í–‰ ì˜¤ë¥˜:", err);
            editor.innerHTML += htmlFromText;
          }
        }

        markDirty();
      }

      function renderPages(pages) {
        pagesContainer.innerHTML = "";
        const usePages =
          Array.isArray(pages) && pages.length
            ? pages
            : [{ id: genId("page"), html: "" }];

        usePages.forEach((page, index) => {
          const wrapper = document.createElement("div");
          wrapper.className = "a4-wrapper";

          const pageEl = document.createElement("div");
          pageEl.className = "a4-page";

          const header = document.createElement("div");
          header.className = "a4-page-header";
          header.textContent = `í˜ì´ì§€ ${index + 1}`;

          const body = document.createElement("div");
          body.className = "page-body";
          body.contentEditable = "true";
          body.dataset.pageId = page.id || genId("page");
          body.innerHTML = page.html || "";

          body.addEventListener("input", () => {
            markDirty();
          });

          body.addEventListener("dragover", (e) => {
            if (
              e.dataTransfer &&
              (Array.from(e.dataTransfer.types).includes("application/json") ||
                Array.from(e.dataTransfer.types).includes("text/plain"))
            ) {
              e.preventDefault();
              e.dataTransfer.dropEffect = "copy";
            }
          });

          body.addEventListener("drop", (e) => {
            if (!e.dataTransfer) return;
            const types = Array.from(e.dataTransfer.types);
            const hasJson = types.includes("application/json");
            const hasText = types.includes("text/plain");
            if (!hasJson && !hasText) return;

            e.preventDefault();
            body.focus();

            let memoData = null;
            if (hasJson) {
              try {
                memoData = JSON.parse(
                  e.dataTransfer.getData("application/json")
                );
              } catch (err) {
                memoData = null;
              }
            }
            const plainText = hasText
              ? e.dataTransfer.getData("text/plain")
              : "";

            const selection = window.getSelection();
            let range;
            if (selection && selection.rangeCount > 0) {
              range = selection.getRangeAt(0);
              if (!body.contains(range.commonAncestorContainer)) {
                range = document.createRange();
                range.selectNodeContents(body);
                range.collapse(false);
              }
            } else {
              range = document.createRange();
              range.selectNodeContents(body);
              range.collapse(false);
            }

            const quote = document.createElement("blockquote");
            const p1 = document.createElement("p");
            p1.textContent =
              (memoData && memoData.text) || plainText || "ì¸ë°•ìŠ¤ ë©”ëª¨";

            const meta = document.createElement("p");
            meta.className = "memo-citation";
            let metaText = "ğŸ“ ì¸ë°•ìŠ¤ ë©”ëª¨";
            if (memoData) {
              const dt = memoData.createdAt ? new Date(memoData.createdAt) : null;
              const dateStr = dt ? dt.toLocaleString() : "";
              const typeStr = memoData.type
                ? memoData.type.toUpperCase()
                : "MEMO";
              metaText +=
                " Â· " +
                typeStr +
                (dateStr ? " Â· " + dateStr : "") +
                (memoData.url ? " Â· " + memoData.url : "");
            }
            meta.textContent = metaText;

            quote.appendChild(p1);
            quote.appendChild(meta);

            range.insertNode(quote);

            const spacer = document.createElement("p");
            spacer.innerHTML = "<br />";
            if (quote.nextSibling) {
              quote.parentNode.insertBefore(spacer, quote.nextSibling);
            } else {
              quote.parentNode.appendChild(spacer);
            }

            markDirty();
          });

          body.addEventListener("paste", handleEditorPaste);

          pageEl.appendChild(header);
          pageEl.appendChild(body);
          wrapper.appendChild(pageEl);
          pagesContainer.appendChild(wrapper);
        });

        pagesMetaEl.textContent = `í˜ì´ì§€ ${usePages.length}`;
      }

      function collectPagesFromDOM() {
        const bodies = pagesContainer.querySelectorAll(".page-body");
        const pages = [];
        bodies.forEach((body) => {
          pages.push({
            id: body.dataset.pageId || genId("page"),
            html: body.innerHTML,
          });
        });
        return pages;
      }

      function setSaveStatus(text) {
        if (!saveStatusEl) return;
        saveStatusEl.textContent = text;
      }

      function markDirty() {
        if (editorState.isSaving) return;
        setSaveStatus("ë³€ê²½ ì‚¬í•­ ì €ì¥ ëŒ€ê¸° ì¤‘â€¦");
        if (editorState.saveTimer) clearTimeout(editorState.saveTimer);
        editorState.saveTimer = setTimeout(() => {
          saveCurrentDoc();
        }, 1000);
      }

      async function saveCurrentDoc() {
        if (!currentUser) return;
        if (!editorState.currentDocId) return;

        if (editorState.saveTimer) {
          clearTimeout(editorState.saveTimer);
          editorState.saveTimer = null;
        }

        const rawTitle = docTitleInput ? docTitleInput.value.trim() : "";
        const title =
          rawTitle ||
          (editorTitleLabel && editorTitleLabel.textContent
            ? editorTitleLabel.textContent.trim()
            : "Untitled Document");

        const tagsRaw = docTagsInput ? docTagsInput.value : "";
        const tags = tagsRaw
          ? Array.from(
              new Set(
                tagsRaw
                  .split(/[,#\s]+/)
                  .map((t) => t.trim())
                  .filter(Boolean)
              )
            ).slice(0, 12)
          : [];

        const pages = collectPagesFromDOM();
        const now = Date.now();

        editorState.isSaving = true;
        setSaveStatus("ì €ì¥ ì¤‘â€¦");

        try {
          const docRef = db
            .collection("users")
            .doc(currentUser.uid)
            .collection("docs")
            .doc(editorState.currentDocId);

          await docRef.set(
            {
              title,
              tags,
              pages,
              updatedAt: now,
              createdAt: editorState.createdAt || now,
            },
            { merge: true }
          );

          editorState.lastSaved = now;
          editorState.createdAt = editorState.createdAt || now;

          if (docMetaCreated) {
            docMetaCreated.textContent = formatDateTime(editorState.createdAt);
          }
          if (docMetaUpdated) {
            docMetaUpdated.textContent = formatDateTime(now);
          }

          const node = findNode(editorState.currentDocId, projectTree);
          if (node) {
            node.title = title;
            persistTree();
            renderProjectTree();
          }

          setSaveStatus("ëª¨ë“  ë³€ê²½ ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          console.error("ë¬¸ì„œ ì €ì¥ ì˜¤ë¥˜:", e);
          setSaveStatus("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          editorState.isSaving = false;
        }
      }

      // íˆ´ë°” â†’ execCommand
      function applyInlineCommand(cmd, value = null) {
        const editor = getActiveEditor();
        if (!editor) return;
        editor.focus();
        try {
          document.execCommand(cmd, false, value);
        } catch (e) {
          console.warn("execCommand ì˜¤ë¥˜:", cmd, e);
        }
        markDirty();
      }

      btnBold.addEventListener("click", () => applyInlineCommand("bold"));
      btnItalic.addEventListener("click", () => applyInlineCommand("italic"));
      btnH2.addEventListener("click", () => {
        const editor = getActiveEditor();
        if (!editor) return;
        editor.focus();
        document.execCommand("formatBlock", false, "h2");
        markDirty();
      });
      btnBullet.addEventListener("click", () =>
        applyInlineCommand("insertUnorderedList")
      );
      btnSaveNow.addEventListener("click", () => saveCurrentDoc());

      if (docTitleInput) {
        docTitleInput.addEventListener("input", () => {
          const node = findNode(projectState.selectedId, projectTree);
          if (node) {
            node.title = docTitleInput.value.trim() || "Untitled Document";
            persistTree();
            renderProjectTree();
          }
          if (editorTitleLabel) {
            editorTitleLabel.textContent =
              docTitleInput.value.trim() || "Untitled Document";
          }
          markDirty();
        });
      }

      if (docTagsInput) {
        docTagsInput.addEventListener("input", () => {
          markDirty();
        });
      }

      // Ctrl/Cmd + S
      window.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
          e.preventDefault();
          saveCurrentDoc();
        }
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Firestore ë¬¸ì„œ ì—´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function openDocForNode(node) {
        if (!currentUser || node.type !== "file") return;
        editorState.currentDocId = node.id;
        setSaveStatus("ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");

        const docRef = db
          .collection("users")
          .doc(currentUser.uid)
          .collection("docs")
          .doc(node.id);

        try {
          const snap = await docRef.get();
          let data;
          const now = Date.now();

          if (snap.exists) {
            data = snap.data();
          } else {
            data = {
              title: node.title || "Untitled Document",
              tags: [],
              pages: [{ id: genId("page"), html: "" }],
              createdAt: now,
              updatedAt: now,
            };
            await docRef.set(data);
          }

          const title =
            (data.title || node.title || "Untitled Document").trim() ||
            "Untitled Document";
          const tags = Array.isArray(data.tags) ? data.tags : [];
          const pages = Array.isArray(data.pages) ? data.pages : [];

          editorState.createdAt = data.createdAt || now;
          editorState.lastSaved = data.updatedAt || data.createdAt || now;

          if (editorTitleLabel) editorTitleLabel.textContent = title;
          if (docTitleInput) docTitleInput.value = title;
          if (docTagsInput) docTagsInput.value = tags.join(", ");
          if (docMetaCreated) {
            docMetaCreated.textContent = formatDateTime(editorState.createdAt);
          }
          if (docMetaUpdated) {
            docMetaUpdated.textContent = formatDateTime(editorState.lastSaved);
          }

          updateEditorEmptyState(true);
          renderPages(pages);
          setSaveStatus("ëª¨ë“  ë³€ê²½ ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          console.error("ë¬¸ì„œ ë¡œë“œ ì˜¤ë¥˜:", e);
          setSaveStatus("ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìš°ì¸¡ íŒ¨ë„: ë©”ëª¨ / AI / ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const connectionData = [
        { id: "c1", title: "ì‹œì¥ ì¡°ì‚¬ ë…¸íŠ¸", type: "note" },
        { id: "c2", title: "ê³ ê° í˜ë¥´ì†Œë‚˜ í”„ë¡œì íŠ¸", type: "project" },
      ];

      let editorMemosCache = [];
      let aiIsLoading = false;
      let relevanceIsLoading = false;

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì˜¨í†¨ë¡œì§€ + ë¡œì»¬ ì—°ê´€ìœ¨ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let ONTOLOGY_RAW = null;
      let ONTOLOGY_TAG_FAMILIES = [];
      let ONTOLOGY_ROLES = [];
      let ONTOLOGY_FLOW_STAGES = [];
      let ONTOLOGY_CONCEPTS = {};

      async function loadOntology() {
        try {
          if (window.location.protocol === "file:") {
            console.warn(
              "file:// í™˜ê²½ì—ì„œëŠ” ontology.jsonì„ fetchí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¨í†¨ë¡œì§€ ì—†ì´ ë¡œì»¬ ì—°ê´€ìœ¨ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );
            return;
          }
          const res = await fetch("ontology.json", { cache: "no-cache" });
          if (!res.ok) {
            console.warn("ontology.json ë¡œë“œ ì‹¤íŒ¨:", res.status);
            return;
          }
          const data = await res.json();
          if (!data || typeof data !== "object") return;

          ONTOLOGY_RAW = data;
          ONTOLOGY_TAG_FAMILIES = Array.isArray(data.tagFamilies)
            ? data.tagFamilies
            : [];
          ONTOLOGY_ROLES = Array.isArray(data.roles) ? data.roles : [];
          ONTOLOGY_FLOW_STAGES = Array.isArray(data.flowStages)
            ? data.flowStages
            : [];

          // tagFamilies â†’ í‰íƒ„í™”í•´ì„œ concept ë§µìœ¼ë¡œ ì •ë¦¬ (Homeê³¼ ë™ì¼ íŒ¨í„´)
          const concepts = {};
          ONTOLOGY_TAG_FAMILIES.forEach((family) => {
            if (!family || !family.id) return;
            const keywords = [];
            if (Array.isArray(family.keywords)) {
              family.keywords.forEach((kw) => {
                if (kw) keywords.push(String(kw));
              });
            }
            if (Array.isArray(family.canonicalTags)) {
              family.canonicalTags.forEach((kw) => {
                if (kw) keywords.push(String(kw));
              });
            }
            if (!keywords.length) return;
            concepts[family.id] = {
              label: family.label || family.id,
              keywords,
            };
          });
          ONTOLOGY_CONCEPTS = concepts;
        } catch (err) {
          console.error("ontology.json ë¡œë“œ ì˜¤ë¥˜:", err);
        }
      }

      function extractConceptsFromText(text) {
        if (!text) return [];
        const lowered = String(text).toLowerCase();
        const source = ONTOLOGY_CONCEPTS || {};
        const concepts = [];
        for (const [concept, value] of Object.entries(source)) {
          const keywords = Array.isArray(value)
            ? value
            : Array.isArray(value.keywords)
            ? value.keywords
            : [];
          if (!keywords.length) continue;
          const matched = keywords.some((kw) =>
            lowered.includes(String(kw).toLowerCase())
          );
          if (matched) concepts.push(concept);
        }
        return Array.from(new Set(concepts));
      }

      function computeLocalRelevance(documentText, memos) {
        const docText = (documentText || "").toLowerCase();
        const docConcepts = extractConceptsFromText(docText);
        const docTokens = docText
          .replace(/[^0-9a-zA-Zê°€-í£\s]/g, " ")
          .split(/\s+/)
          .filter(Boolean);
        const docTokenSet = new Set(docTokens);

        return memos
          .map((m) => {
            const memoText = ((m.text || "") + " " + (m.url || "")).toLowerCase();
            const memoConcepts = extractConceptsFromText(memoText);
            const memoTokens = memoText
              .replace(/[^0-9a-zA-Zê°€-í£\s]/g, " ")
              .split(/\s+/)
              .filter(Boolean);

            let overlapCount = 0;
            memoTokens.forEach((t) => {
              if (docTokenSet.has(t)) overlapCount++;
            });

            const tagOverlap =
              Array.isArray(m.tags) && m.tags.length
                ? m.tags.filter((t) =>
                    docText.includes(String(t).toLowerCase())
                  )
                : [];

            const conceptOverlap = docConcepts.filter((c) =>
              memoConcepts.includes(c)
            );

            let score = 0;
            if (overlapCount && docTokens.length) {
              score += overlapCount / docTokens.length;
            }
            score += tagOverlap.length * 0.4;
            score += conceptOverlap.length * 0.6;
            if (m.type === "note") score += 0.05;
            if (m.type === "memo") score += 0.03;

            return {
              memo: m,
              score,
              tagOverlap,
              conceptOverlap,
            };
          })
          .sort((a, b) => b.score - a.score);
      }

      function renderEditorMemos() {
        const container = document.getElementById("editor-memo-list");
        if (!container) return;

        const memos = editorMemosCache
          .slice()
          .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

        if (!memos.length) {
          container.innerHTML =
            '<p class="text-xs text-muted-foreground">Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¨ ì¸ë°•ìŠ¤ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        container.innerHTML = memos
          .map((memo) => {
            const tags = memo.tags || [];
            const typeLabel = memo.type ? memo.type.toUpperCase() : "MEMO";
            const createdAtLabel = memo.createdAt
              ? new Date(memo.createdAt).toLocaleString()
              : "";
            return `
              <article
                class="memo-card rounded-md border border-border/70 bg-muted/30 px-3 py-2 cursor-grab active:cursor-grabbing text-xs"
                data-memo-id="${memo.id}"
                draggable="true"
              >
                <div class="flex items-center justify-between gap-2">
                  <p class="text-[11px] text-muted-foreground">
                    ${typeLabel}
                    ${
                      createdAtLabel
                        ? ` Â· <span>${createdAtLabel}</span>`
                        : ""
                    }
                  </p>
                  ${
                    memo.url
                      ? `<i data-lucide="link-2" class="h-3 w-3 text-muted-foreground flex-shrink-0"></i>`
                      : ""
                  }
                </div>
                <p class="mt-1 text-xs line-clamp-2">
                  ${memo.text || memo.url || ""}
                </p>
                ${
                  memo.url
                    ? `<a href="${memo.url}" target="_blank" class="mt-1 inline-flex items-center gap-1 text-[11px] text-primary hover:underline">
                        <i data-lucide="external-link" class="h-3 w-3"></i>
                        ë§í¬ ì—´ê¸°
                      </a>`
                    : ""
                }
                ${
                  tags.length
                    ? `<div class="mt-1 flex flex-wrap gap-1">
                        ${tags
                          .map(
                            (t) =>
                              `<span class="rounded-full bg-secondary px-2 py-0.5 text-[10px] text-secondary-foreground">${t}</span>`
                          )
                          .join("")}
                      </div>`
                    : ""
                }
              </article>
            `;
          })
          .join("");

        container.querySelectorAll("[data-memo-id]").forEach((el) => {
          const id = el.getAttribute("data-memo-id");
          const memo = memos.find((m) => String(m.id) === String(id));
          if (!memo) return;

          el.addEventListener("dragstart", (e) => {
            e.dataTransfer.effectAllowed = "copy";
            const textForDrop = memo.text || memo.url || "";
            e.dataTransfer.setData("text/plain", textForDrop);
            e.dataTransfer.setData("application/json", JSON.stringify(memo));
          });
        });

        if (window.lucide) window.lucide.createIcons();
      }

      function renderMemoPane() {
        const memoTab = document.getElementById("memo-tab");
        if (!memoTab) return;

        memoTab.innerHTML = `
          <div class="p-4 border-b border-border">
            <h3 class="font-semibold text-foreground flex items-center gap-2 mb-1">
              <i data-lucide="sticky-note" class="h-[18px] w-[18px] text-accent"></i>
              ì¸ë°•ìŠ¤ ë©”ëª¨
            </h3>
          </div>
          <div class="h-[calc(100%-90px)] overflow-y-auto">
            <div class="p-3 space-y-2" id="editor-memo-list"></div>
          </div>
        `;

        renderEditorMemos();
      }

      const MEMO_SUBSCRIBE_LIMIT = 100;

      function subscribeEditorMemos(user) {
        if (!user) {
          editorMemosCache = [];
          renderEditorMemos();
          return;
        }

        db.collection("users")
          .doc(user.uid)
          .collection("memos")
          .orderBy("createdAt", "desc")
          .limit(MEMO_SUBSCRIBE_LIMIT)
          .onSnapshot(
            (snapshot) => {
              editorMemosCache = snapshot.docs.map((doc) => {
                const data = doc.data() || {};
                const raw = data.createdAt;
                let createdAt = null;
                if (raw && typeof raw.toMillis === "function") {
                  createdAt = raw.toMillis();
                } else if (typeof raw === "number") {
                  createdAt = raw;
                }

                return {
                  id: doc.id,
                  text: data.text || "",
                  url: data.url || "",
                  tags: data.tags || [],
                  type: data.type || "memo",
                  createdAt,
                };
              });
              renderEditorMemos();
            },
            (err) => {
              console.error("ì—ë””í„° ë©”ëª¨ êµ¬ë… ì˜¤ë¥˜:", err);
            }
          );
      }

      function renderAiTab() {
        const ai = document.getElementById("ai-tab");
        if (!ai) return;
        ai.innerHTML = `
          <div class="flex flex-col h-full">
            <div class="mb-3 space-y-1">
              <p class="text-sm font-medium text-foreground">AI ì–´ì‹œìŠ¤í„´íŠ¸</p>
            </div>
            <div
              id="ai-chat-log"
              class="flex-1 min-h-[160px] rounded-lg border border-border bg-muted/40 p-3 overflow-y-auto space-y-3 text-xs"
            >
              <div class="text-[11px] text-muted-foreground">
                ğŸ’¬ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ê´€ë ¨ëœ ë©”ëª¨/ë¬¸ì„œ ì¡°ê°ë“¤ì„ ì°¾ì•„ì„œ, ê·¸ ì•ˆì—ì„œë§Œ ë‹µë³€í•´ ì¤ë‹ˆë‹¤.
              </div>
            </div>
            <form id="ai-chat-form" class="mt-3 flex flex-col gap-2">
              <textarea
                id="ai-question"
                rows="2"
                class="w-full rounded-lg border border-border bg-background px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-primary/40"
                placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? (ì˜ˆ: 'ì§€ë‚œì£¼ ì‹œì¥ ì¡°ì‚¬ ë©”ëª¨ ì •ë¦¬í•´ì¤˜')"
              ></textarea>
              <div class="flex items-center justify-between gap-2">
                <p id="ai-helper-text" class="text-[11px] text-muted-foreground">
                  â†© ì¤„ë°”ê¿ˆ, <kbd class="px-1 py-0.5 border rounded">Ctrl</kbd> + <kbd class="px-1 py-0.5 border rounded">Enter</kbd> ë¡œ ì „ì†¡
                </p>
                <button
                  type="submit"
                  id="ai-send-btn"
                  class="inline-flex items-center gap-1 rounded-full bg-primary px-3 py-1.5 text-[11px] font-medium text-primary-foreground shadow hover:bg-primary/90 disabled:opacity-50"
                >
                  <span class="ai-send-label">ì§ˆë¬¸ ë³´ë‚´ê¸°</span>
                  <i data-lucide="send" class="w-3 h-3"></i>
                </button>
              </div>
            </form>
          </div>
        `;
      }

      function renderLinkTab() {
        const link = document.getElementById("link-tab");
        if (!link) return;

        link.innerHTML = `
          <div class="space-y-2">
            <p class="text-sm font-medium text-foreground">ì—°ê²° ë° ì—°ê´€ìœ¨</p>
            <p class="text-xs text-muted-foreground">
              í˜„ì¬ ì—´ë ¤ ìˆëŠ” ë¬¸ì„œì™€ ì¸ë°•ìŠ¤ ë©”ëª¨ë“¤ì„ ê¸°ì¤€ìœ¼ë¡œ ChatGPT APIë¡œ ê³„ì‚°í•œ ì—°ê´€ìœ¨ì…ë‹ˆë‹¤.
            </p>
          </div>
          <div class="mt-3 flex items-center justify-between gap-2">
            <button
              type="button"
              id="relevance-refresh-btn"
              class="inline-flex items-center gap-1 rounded-full border border-border bg-background px-3 py-1.5 text-[11px] font-medium text-foreground shadow-sm hover:bg-accent/40 transition-colors"
            >
              <i data-lucide="sparkles" class="h-3.5 w-3.5"></i>
              ì—°ê´€ìœ¨ ë‹¤ì‹œ ê³„ì‚°
            </button>
            <p id="relevance-status" class="text-[11px] text-muted-foreground"></p>
          </div>
          <div id="relevance-list" class="mt-3 space-y-2 text-xs"></div>
        `;

        const btn = document.getElementById("relevance-refresh-btn");
        if (btn) {
          btn.addEventListener("click", () => {
            computeAndRenderRelevance();
          });
        }

        if (window.lucide) window.lucide.createIcons();
      }

      function setRelevanceStatus(text) {
        const el = document.getElementById("relevance-status");
        if (!el) return;
        el.textContent = text;
      }

      function setRelevanceLoading(loading) {
        relevanceIsLoading = loading;
        const btn = document.getElementById("relevance-refresh-btn");
        if (btn) {
          btn.disabled = loading;
        }
        if (loading) {
          setRelevanceStatus("ì—°ê´€ìœ¨ ê³„ì‚° ì¤‘â€¦");
        }
      }

      function renderRelevanceResults(items) {
        const list = document.getElementById("relevance-list");
        if (!list) return;

        if (!items || !items.length) {
          list.innerHTML =
            '<p class="text-xs text-muted-foreground">ì—°ê´€ëœ í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
          return;
        }

        list.innerHTML = items
          .map((item) => {
            const title = item.title || "ì œëª© ì—†ìŒ";
            const score = typeof item.score === "number" ? item.score : item.relevance;
            let percent = 0;
            if (typeof score === "number") {
              if (score <= 1) {
                percent = Math.round(score * 100);
              } else {
                percent = Math.round(score);
              }
            }
            const topSentence =
              item.topSentence || item.snippet || item.bestSentence || "";
            const reason = item.reason || item.why || "";

            return `
              <article class="rounded-lg border border-border bg-muted/30 px-3 py-2">
                <div class="flex items-center justify-between gap-2">
                  <p class="text-xs font-semibold text-foreground truncate">
                    ${title}
                  </p>
                  <p class="text-[11px] text-muted-foreground flex-shrink-0">
                    ì—°ê´€ìœ¨: <span class="font-semibold">${percent}%</span>
                  </p>
                </div>
                <div class="mt-2">
                  <p class="text-[11px] font-medium text-muted-foreground mb-0.5">
                    ê°€ì¥ ì—°ê´€ ìˆëŠ” ë¬¸ì¥
                  </p>
                  <p class="text-xs text-foreground whitespace-pre-wrap">
                    ${topSentence || "-"}
                  </p>
                </div>
                <div class="mt-2">
                  <p class="text-[11px] font-medium text-muted-foreground mb-0.5">
                    why
                  </p>
                  <p class="text-xs text-foreground whitespace-pre-wrap">
                    ${reason || "-"}
                  </p>
                </div>
              </article>
            `;
          })
          .join("");
      }

      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Cloud Functions (onCall) í˜¸ì¶œ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Graphì™€ ë™ì¼í•˜ê²Œ firebase-functions SDK(compat)ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ,
      // HTTPS callable ì—”ë“œí¬ì¸íŠ¸ë¥¼ fetchë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Cloud Functions (onCall) í˜¸ì¶œ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // CORS ì´ìŠˆë¥¼ í”¼í•˜ë ¤ë©´, ë¸Œë¼ìš°ì €ì—ì„œ Gen2 callable ì—”ë“œí¬ì¸íŠ¸ë¥¼ "ì§ì ‘ fetch"ë¡œ ì¹˜ì§€ ë§ê³ 
      // Firebase Functions SDKì˜ httpsCallableì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. (Home/Graphì™€ ë™ì¼ íŒ¨í„´)
      async function callFirebaseCallable(functionName, payload) {
        if (__fw_isLocalFile) {
          throw new Error(
            "ë¡œì»¬ íŒŒì¼(file://)ì—ì„œëŠ” Cloud Functionsë¥¼ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase Hosting ë“± ë°°í¬ëœ ë„ë©”ì¸ì—ì„œ ì ‘ì†í•´ ì£¼ì„¸ìš”."
          );
        }

        if (!functions || typeof functions.httpsCallable !== "function") {
          throw new Error("firebase-functions-compat SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. headì— firebase-functions-compat.jsë¥¼ ì¶”ê°€í•˜ì„¸ìš”.");
        }

        // Callable: SDKê°€ ì¸ì¦/í˜•ì‹/ì—ëŸ¬ ì‘ë‹µì„ í‘œì¤€í™”í•©ë‹ˆë‹¤.
        const callable = functions.httpsCallable(functionName);
        const resp = await callable(payload);

        // httpsCallable ì‘ë‹µì€ { data: ... } í˜•íƒœ
        return resp && typeof resp === "object" && "data" in resp ? resp.data : resp;
      }

async function computeAndRenderRelevance() {
        if (relevanceIsLoading) return;

        const list = document.getElementById("relevance-list");
        if (!list) return;

        if (__fw_isLocalFile) {
          setRelevanceStatus(
            "ë¡œì»¬ íŒŒì¼(file://)ì—ì„œëŠ” ì—°ê´€ìœ¨ ê³„ì‚°ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase Hosting ë“± ë°°í¬ëœ ë„ë©”ì¸ì—ì„œ í™•ì¸í•´ ì£¼ì„¸ìš”."
          );
          list.innerHTML =
            '<p class="text-xs text-muted-foreground">ë¡œì»¬ íŒŒì¼(file://)ì—ì„œëŠ” ì—°ê´€ìœ¨ ê³„ì‚°ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase Hosting ë“± ë°°í¬ëœ ë„ë©”ì¸ì—ì„œ ì ‘ì†í•´ ì£¼ì„¸ìš”.</p>';
          return;
        }

        if (!currentUser) {
          setRelevanceStatus("ë¡œê·¸ì¸ í›„ ì—°ê´€ìœ¨ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          list.innerHTML =
            '<p class="text-xs text-muted-foreground">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
          return;
        }

        if (!editorState.currentDocId) {
          setRelevanceStatus("ì—´ë ¤ ìˆëŠ” ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
          list.innerHTML =
            '<p class="text-xs text-muted-foreground">ë¨¼ì € ë¬¸ì„œë¥¼ í•˜ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
          return;
        }

        setRelevanceLoading(true);
        list.innerHTML = "";

        try {

          const editors = Array.from(
            document.querySelectorAll(".page-body")
          );
          const pages = editors.map((ed, index) => ({
            index,
            text: ed.innerText || "",
          }));

          const fullDocText = pages.map((p) => p.text).join("\n\n");

          const titleText =
            (docTitleInput && docTitleInput.value.trim()) ||
            (editorTitleLabel && editorTitleLabel.textContent
              ? editorTitleLabel.textContent.trim()
              : "ì œëª© ì—†ëŠ” ë¬¸ì„œ");

          const docConcepts = extractConceptsFromText(fullDocText);

          const docCtx = {
            id: editorState.currentDocId,
            title: titleText,
            pages,
            concepts: docConcepts,
          };

          const baseMemos = (editorMemosCache || []).map((m) => ({
            id: m.id,
            text: m.text || "",
            url: m.url || "",
            type: m.type || "memo",
            createdAt: m.createdAt || null,
            tags: m.tags || [],
          }));

          let selectedMemos = baseMemos;
          let clientRanking = [];

          if (baseMemos.length) {
            const ranked = computeLocalRelevance(fullDocText, baseMemos);
            const TOP_N = 12;
            const nonZero = ranked.filter((r) => r.score > 0);
            const picked = (nonZero.length ? nonZero : ranked).slice(
              0,
              TOP_N
            );
            selectedMemos = picked.map((r) => r.memo);
            clientRanking = picked.map((r) => ({
              id: r.memo.id,
              score: r.score,
              tags: r.tagOverlap,
              concepts: r.conceptOverlap,
            }));
          }
          const data = (await callFirebaseCallable("computeRelevance", {
            document: docCtx,
                        memos: selectedMemos,
                        clientRanking,
          })) || {};
          const items = Array.isArray(data.items)
            ? data.items
            : Array.isArray(data.results)
            ? data.results
            : [];

          renderRelevanceResults(items);

          if (items.length) {
            setRelevanceStatus(`ì´ ${items.length}ê°œì˜ í•­ëª©ì´ ì—°ê´€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
          } else {
            setRelevanceStatus("ì—°ê´€ëœ í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (e) {
          console.error("ì—°ê´€ìœ¨ ê³„ì‚° ì˜¤ë¥˜:", e);
          if (
            e &&
            (e.code === "functions/internal" ||
              e.code === "internal" ||
              (typeof e.message === "string" &&
                e.message.toLowerCase().includes("internal")))
          ) {
            setRelevanceStatus("ì—°ê´€ìœ¨ ê³„ì‚° ì¤‘ Cloud Functions ë‚´ë¶€ ì˜¤ë¥˜(CORS ê°€ëŠ¥ì„±) ë°œìƒ");
            list.innerHTML =
              '<p class="text-xs text-destructive-foreground">ì—°ê´€ìœ¨ ê³„ì‚° í˜¸ì¶œ ì¤‘ Cloud Functions(computeRelevance)ì—ì„œ CORS ì„¤ì • ë˜ëŠ” region/í•¨ìˆ˜ íƒ€ì…(onCall/onRequest) ë¬¸ì œë¡œ ì‘ë‹µì´ ë§‰í˜”ìŠµë‹ˆë‹¤.<br/>editor.html ìª½ ì½”ë“œëŠ” ì´ë¯¸ <code>httpsCallable("computeRelevance")</code>ë¡œ ì˜¬ë°”ë¥´ê²Œ í˜¸ì¶œ ì¤‘ì´ë¯€ë¡œ, Firebase Functions ì½˜ì†”ì—ì„œ <strong>computeRelevance í•¨ìˆ˜ì˜ regionê³¼ íƒ€ì…(onCall), ê·¸ë¦¬ê³  Access-Control-Allow-Origin í—¤ë” ì„¤ì •</strong>ì„ í™•ì¸Â·ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>';
          } else {
            setRelevanceStatus("ì—°ê´€ìœ¨ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            list.innerHTML =
              '<p class="text-xs text-destructive-foreground">ì—°ê´€ìœ¨ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
          }
        } finally {
          setRelevanceLoading(false);
        }
      }

      function appendChatMessage(role, content, sources) {
        const log = document.getElementById("ai-chat-log");
        if (!log) return;
        const wrapper = document.createElement("div");
        wrapper.className =
          role === "user" ? "flex justify-end" : "flex justify-start";

        const bubble = document.createElement("div");
        bubble.className =
          "max-w-[90%] rounded-2xl px-3 py-2 text-[11px] whitespace-pre-wrap break-words " +
          (role === "user"
            ? "bg-primary text-primary-foreground"
            : "bg-card border border-border text-foreground");

        bubble.textContent = content;
        wrapper.appendChild(bubble);

        if (role === "assistant" && Array.isArray(sources) && sources.length) {
          const srcBox = document.createElement("div");
          srcBox.className =
            "mt-2 pt-1 border-t border-dashed border-border/60 space-y-1";

          const title = document.createElement("p");
          title.className = "text-[10px] font-semibold text-muted-foreground";
          title.textContent = "ğŸ“ ê´€ë ¨ ì¶œì²˜";
          srcBox.appendChild(title);

          sources.forEach((src) => {
            const line = document.createElement("div");
            line.className =
              "flex flex-col gap-0.5 text-[10px] text-muted-foreground";

            const meta = document.createElement("span");
            meta.textContent =
              (src.type === "memo" ? "[ë©”ëª¨]" : "[ë¬¸ì„œ]") +
              (src.title ? " " + src.title : "") +
              (src.page ? ` (p.${src.page})` : "");
            line.appendChild(meta);

            if (src.snippet) {
              const snip = document.createElement("span");
              snip.className = "line-clamp-2";
              snip.textContent = src.snippet;
              line.appendChild(snip);
            }

            srcBox.appendChild(line);
          });

          bubble.appendChild(srcBox);
        }

        log.appendChild(wrapper);
        log.scrollTop = log.scrollHeight;
      }

      function setAiLoading(loading) {
        aiIsLoading = loading;
        const btn = document.getElementById("ai-send-btn");
        const label = btn ? btn.querySelector(".ai-send-label") : null;
        if (btn) {
          btn.disabled = loading;
        }
        if (label) {
          label.textContent = loading ? "ìƒì„± ì¤‘..." : "ì§ˆë¬¸ ë³´ë‚´ê¸°";
        }
      }

      function setupAiChat() {
        const form = document.getElementById("ai-chat-form");
        const textarea = document.getElementById("ai-question");

        if (!form || !textarea) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (aiIsLoading) return;

          const question = textarea.value.trim();
          if (!question) return;

          if (__fw_isLocalFile) {
            appendChatMessage(
              "assistant",
              "ë¡œì»¬ íŒŒì¼(file://)ì—ì„œ ì—´ë ¤ ìˆì–´ Cloud Functionsë¥¼ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase Hosting ë“± ë°°í¬ëœ ë„ë©”ì¸ì—ì„œ ì ‘ì†í•´ ì£¼ì„¸ìš”."
            );
            return;
          }

          if (!currentUser) {
            alert("ë¡œê·¸ì¸ í›„ AI ì–´ì‹œìŠ¤í„´íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          appendChatMessage("user", question);
          textarea.value = "";
          setAiLoading(true);

          try {
            const editors = Array.from(
              document.querySelectorAll(".page-body")
            );
            const pages = editors.map((ed, index) => ({
              index,
              text: ed.innerText || "",
            }));

            const titleText =
              (docTitleInput && docTitleInput.value.trim()) ||
              (editorTitleLabel && editorTitleLabel.textContent
                ? editorTitleLabel.textContent.trim()
                : "ì œëª© ì—†ëŠ” ë¬¸ì„œ");

            const docCtx = {
              id: editorState.currentDocId,
              title: titleText,
              pages,
            };

            const payloadMemos = (editorMemosCache || []).map((m) => ({
              id: m.id,
              text: m.text || "",
              url: m.url || "",
              type: m.type || "memo",
              createdAt: m.createdAt || null,
              tags: m.tags || [],
            }));
            const data = (await callFirebaseCallable("qaWithContext", {
              question,
                            document: docCtx,
                            memos: payloadMemos,
            })) || {};
            const answer =
              data.answer ||
              "AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
            const sources = Array.isArray(data.sources) ? data.sources : [];

            appendChatMessage("assistant", answer, sources);
          } catch (err) {
            console.error("AI í˜¸ì¶œ ì˜¤ë¥˜:", err);
            appendChatMessage(
              "assistant",
              "AI í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
            );
          } finally {
            setAiLoading(false);
          }
        });

        textarea.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            form.dispatchEvent(new Event("submit", { cancelable: true }));
          }
        });
      }

      function setupTabs() {
        const triggers = document.querySelectorAll(".tab-trigger");
        const contents = document.querySelectorAll(".tab-content");

        function activate(tab) {
          triggers.forEach((btn) => {
            const isActive = btn.dataset.tab === tab;
            btn.classList.toggle("bg-card", isActive);
            btn.classList.toggle("shadow-sm", isActive);
            btn.classList.toggle("text-foreground", isActive);
            if (!isActive) {
              btn.classList.add("text-muted-foreground");
            } else {
              btn.classList.remove("text-muted-foreground");
            }
          });

          contents.forEach((sec) => {
            sec.style.display =
              sec.dataset.content === tab ? "block" : "none";
          });

          if (tab === "memo") {
            renderEditorMemos();
          }
          if (tab === "link") {
            computeAndRenderRelevance();
          }
        }

        triggers.forEach((btn) => {
          btn.addEventListener("click", () => {
            activate(btn.dataset.tab);
            if (window.lucide) window.lucide.createIcons();
          });
        });

        activate("ai");
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function initForUser() {
        projectTree = [];

        let remoteTree = await loadTreeFromFirestore(currentUser);
        projectTree = Array.isArray(remoteTree) ? remoteTree : [];

        renderProjectTree();

        const firstFile = getFirstFileNode();
        if (firstFile) {
          projectState.selectedId = firstFile.id;
          renderProjectTree();
          openDocForNode(firstFile);
        } else {
          updateEditorEmptyState(false);
        }

        // After loading the initial tree/doc, check if the URL specifies a doc ID to open
        await handleDraftDocFromQuery();
      }

      // ìš°ì¸¡ íŒ¨ë„ ì¤€ë¹„
      renderAiTab();
      renderMemoPane();
      renderLinkTab();
      setupTabs();
      setupAiChat();

      // ì˜¨í†¨ë¡œì§€ ë¡œë“œ
      loadOntology();

      
      // Auth gate (Graph/Homeê³¼ ë™ì¼í•œ ë°©ì‹)
      let __fw_authGateTimer = null;

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          if (__fw_isLocalFile) {
            if (__fw_authGateTimer) {
              clearTimeout(__fw_authGateTimer);
              __fw_authGateTimer = null;
            }
            showToast("ë¡œì»¬ íŒŒì¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. Firebase ì„¸ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ Hosting URLì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.");
            return;

          // ğŸ”¸ ê°œë°œ ì„œë²„(localhost)ì—ì„œ ì—´ë©´ í”„ë¡œë•ì…˜(web.app) ë¡œê·¸ì¸ ì„¸ì…˜ì´ ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          //    ì´ ê²½ìš°ì—ëŠ” localhostì˜ login.htmlì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
          if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
            try { showToast("í˜„ì¬ localhostì—ì„œ ì—´ë ¤ ìˆì–´ í”„ë¡œë•ì…˜ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. localhostì˜ login.htmlì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”."); } catch (_) {}
          }

          }

          if (__fw_authGateTimer) clearTimeout(__fw_authGateTimer);
          __fw_authGateTimer = setTimeout(() => {
            try {
              if (!auth.currentUser) {
                localStorage.removeItem(AUTH_KEY);
                window.location.replace("login.html");
              }
            } catch (_) {
              window.location.replace("login.html");
            }
          }, 3000);
          return;
        }

        if (__fw_authGateTimer) {
          clearTimeout(__fw_authGateTimer);
          __fw_authGateTimer = null;
        }

        let onboardingComplete = false;
        try {
          const profile = await ensureUserProfile(user);
          onboardingComplete = !!profile.onboardingComplete;
        } catch (e) {
          const cached = readAuthCache();
          onboardingComplete = !!(cached && cached.uid === user.uid && cached.onboardingComplete);
          console.warn("Profile load failed; falling back to cache:", e);
        }

        writeAuthCache(user, onboardingComplete);

        if (!onboardingComplete) {
          window.location.replace("onboarding.html");
          return;
        }

        currentUser = user;
        try {
          await initForUser();
        } catch (e) {
          console.error("initForUser ì˜¤ë¥˜:", e);
        }
        try {
          subscribeEditorMemos(user);
        } catch (e) {
          console.error("subscribeEditorMemos ì˜¤ë¥˜:", e);
        }
      });
// ì•„ì´ì½˜ ì´ˆê¸° ë Œë”
      if (window.lucide) window.lucide.createIcons();
    </script>
  </body>
</html>
